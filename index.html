<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nulane Systems Portal</title>
    <!-- Bootstrap -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <!-- Bootstrap Select (searchable dropdowns) -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css"
            rel="stylesheet"
    />
    <style>
        :root {
--brand: #003b78;~
          --brand-accent: #0d6efd;
          --bg: #f4f6fa;
          --card: #ffffff;
        --sidebar-bg: #1f2632;
        --sidebar-text: #f8fafc;
        --sidebar-link: #cbd5f5;
        --sidebar-link-hover: #ffffff;
          --text-primary: #12161f;
          --text-muted: #5f6c7b;
          --border-subtle: #dbe2ee;
          --vin-box-bg: #eef3fb;
          --vin-box-border: #d7e3ff;
          --input-bg: #ffffff;
          --input-border: #c6ceda;
          --manual-override-border: #c48c04;
          --manual-override-bg: #fff7e0;
          --manual-override-glow: rgba(196, 140, 4, 0.18);
        }
        body {
          font-family: "Inter", Arial, sans-serif;
          background: var(--bg);
          color: var(--text-primary);
          margin: 0;
          transition: background-color 0.3s, color 0.3s;
        }
        a,
        .btn-link {
          text-decoration: none;
        }
        body .text-muted,
        .hint {
          color: var(--text-muted) !important;
        }
        /* Shell */
        #portal {
          display: flex;
        }
        #portal.sidebar-collapsed #sidebar {
          width: 72px;
          flex: 0 0 72px;
          min-width: 72px;
          max-width: 72px;
        }
        #portal.sidebar-collapsed #sidebar-header img {
          width: 60px;
        }
        #sidebar {
          background-color: var(--sidebar-bg);
          color: var(--sidebar-text);
          width: 260px;
          display: flex;
          flex-direction: column;
          flex: 0 0 260px;
          min-width: 260px;
          max-width: 260px;
          position: sticky;
          top: 0;
          height: 100vh;
          overflow: hidden;
          transition: width 0.3s ease, min-width 0.3s ease;
        }
        #sidebar-header {
          background: rgba(255, 255, 255, 0.05);
          padding: 1.25rem 1rem;
          text-align: center;
          display: flex;
          align-items: center;
          justify-content: center;
          position: sticky;
          top: 0;
          z-index: 3;
        }
        #sidebar-header img {
          width: 90px;
          transition: width 0.3s ease;
          position: relative;
          z-index: 1;
        }
        #sidebar-header.logo-rect.interrail img {
          width: 140px;
          height: auto;
        }
        #sidebar-header.logo-rect::before {
          content: "";
          position: absolute;
          top: 50%;
          left: 0;
          right: 0;
          width: 100%;
          height: 64px;
          transform: translateY(-50%);
          background: #ffffff;
          border: 2px solid rgba(0, 0, 0, 0.05);
          pointer-events: none;
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.16);
        }
        #sidebar-header.logo-rect.interrail::before {
          top: 0;
          transform: none;
          height: 100%;
        }
        .sidebar-collapse-btn {
          border: none;
          background: rgba(255, 255, 255, 0.1);
          color: inherit;
          width: 34px;
          height: 34px;
          border-radius: 999px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          flex-shrink: 0;
          margin-left: auto;
        }
        .sidebar-collapse-btn:hover {
          background: rgba(255, 255, 255, 0.2);
        }
        .sidebar-collapse-btn:focus-visible {
          outline: 2px solid var(--brand-accent);
          outline-offset: 2px;
        }
        .sidebar-toggle-icon {
          width: 18px;
          height: 18px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          transition: transform 0.3s ease;
        }
        #portal.sidebar-collapsed .sidebar-toggle-icon {
          transform: rotate(180deg);
        }
        #sidebar-content {
          padding: 1.5rem 1rem;
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          overflow-y: auto;
        }
        .sidebar-nav {
          display: flex;
          flex-direction: column;
          gap: 0.35rem;
          flex: 1;
          transition: gap 0.3s ease;
        }
        .nav-section-heading {
          font-size: 0.72rem;
          letter-spacing: 0.12em;
          text-transform: uppercase;
          color: rgba(255, 255, 255, 0.7);
          margin: 0.75rem 0 0.35rem;
        }
        .sidebar-nav .nav-link {
          display: flex;
          align-items: center;
          gap: 0.65rem;
          width: 100%;
          padding: 0.55rem 1rem;
          border-radius: 0.5rem;
          color: var(--sidebar-link);
          font-weight: 500;
          text-decoration: none;
          transition: background 0.3s ease, color 0.3s ease;
        }
        .sidebar-nav .nav-link:hover {
          color: var(--sidebar-link-hover);
          background: rgba(255, 255, 255, 0.1);
        }
        .sidebar-nav .nav-link.active {
          background: rgba(255, 255, 255, 0.15);
          color: var(--sidebar-link-hover);
        }
        .nav-link-icon {
          font-size: 1.1rem;
          width: 24px;
          height: 24px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          color: inherit;
        }
        .nav-link-icon svg {
          width: 20px;
          height: 20px;
          fill: currentColor;
        }
        .nav-link-logo {
          width: 38px;
          height: 38px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border-radius: 12px;
          background: rgba(255, 255, 255, 0.6);
          padding: 2px;
          border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .nav-link-logo img {
          width: 100%;
          height: 100%;
          object-fit: contain;
          display: block;
          background: #ffffff;
          border-radius: 10px;
          padding: 2px;
        }
        }
        .nav-link-label {
          flex: 1;
        }
        #sidebar-content h5 {
          color: var(--sidebar-text);
        }
        #sidebar-content hr {
          border-color: rgba(255, 255, 255, 0.12);
        }
        #sidebar-content a {
          text-decoration: none;
        }
        #sidebar-content a.active,
        #sidebar-content a:hover {
          background: var(--brand-accent);
          color: var(--sidebar-link-hover);
        }
        .sidebar-footer {
          margin-top: auto;
          transition: opacity 0.3s ease;
          position: sticky;
          bottom: 0;
          padding-top: 0.75rem;
          background: transparent !important;
        }
        #logout {
          color: #ffffff;
          font-weight: 600;
          background: #d32f2f;
          border-radius: 0.65rem;
          border: 1px solid rgba(255, 255, 255, 0.25);
          padding: 0.55rem 0.85rem;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 0.5rem;
          width: 100%;
          margin-bottom: 0;
        }
        #logout:hover {
          background: #b71c1c;
          color: #ffffff;
        }
        #logout .logout-icon {
          width: 26px;
          height: 26px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }
        #logout .logout-icon svg {
          width: 22px;
          height: 22px;
        }
        #logout .logout-label {
          flex: 1;
        }
        #portal.sidebar-collapsed #sidebar-content {
          padding: 1.25rem 0.4rem;
          align-items: center;
        }
        #portal.sidebar-collapsed .sidebar-nav {
          gap: 0.15rem;
        }
        #portal.sidebar-collapsed .sidebar-nav .nav-link {
          justify-content: center;
          padding: 0.45rem 0;
        }
        #portal.sidebar-collapsed .nav-link-icon {
          margin-right: 0;
        }
        #portal.sidebar-collapsed .nav-link-label {
          display: none;
        }
        #portal.sidebar-collapsed #sidebar-content hr {
          display: none;
        }
        #portal.sidebar-collapsed .sidebar-footer {
          margin-top: 0.25rem;
        }
        #portal.sidebar-collapsed #logout {
          padding: 0.45rem;
          width: 52px;
          border-radius: 999px;
          justify-content: center;
        }
        #portal.sidebar-collapsed .logout-label {
          display: none;
        }
        .powered-by-nulane-wrapper {
          display: flex;
          justify-content: center;
          margin-bottom: 0.6rem;
          background: transparent;
          padding: 0;
          border: none;
        }
        .powered-by-nulane-wrapper img {
          max-width: 140px;
          width: 100%;
          height: auto;
          display: block;
        }
        .page-section {
          display: none;
        }
        .page-section.active {
          display: block;
        }
        .hint {
          font-size: 0.92rem;
        }
        /* Cards */
        .card-step {
          background: var(--card);
          border-radius: 0.85rem;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
          padding: 1.25rem;
          margin-bottom: 1.25rem;
          border: 1px solid var(--border-subtle);
          color: var(--text-primary);
        }
        .card-step h5 {
          font-weight: 700;
          margin-bottom: 0.75rem;
        }
        .powerbi-embed {
          min-height: 420px;
          border-radius: 0.85rem;
          padding: 1.5rem;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          overflow: hidden;
        }
        .powerbi-embed::after {
          content: "";
          position: absolute;
          left: -1px;
          right: -1px;
          bottom: -1px;
          height: calc(9% + 1px);
          background: var(--card);
          opacity: 1;
          pointer-events: auto;
          border-bottom-left-radius: 0.65rem;
          border-bottom-right-radius: 0.65rem;
          z-index: 5;
        }
        .powerbi-embed-placeholder {
          width: 100%;
          min-height: 320px;
          border-radius: 0.85rem;
          border: none;
          padding: 1.5rem;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 0.5rem;
          background: var(--vin-box-bg);
        }
        .powerbi-embed-placeholder code {
          font-size: 0.85rem;
          padding: 0.1rem 0.5rem;
          border-radius: 0.35rem;
          background: #eff2f7;
          font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }
        .damage-entry-table th {
          letter-spacing: 0.05em;
          font-size: 0.65rem;
          color: var(--text-muted);
        }
        .damage-table-title {
          font-size: 0.75rem;
          letter-spacing: 0.03em;
          text-transform: none;
          text-align: center;
          display: block;
          width: 100%;
        }
        .damage-table-wrapper {
          width: 100%;
          display: flex;
          justify-content: center;
        }
        .damage-entry-table td {
          padding-top: 0.35rem;
          padding-bottom: 0.35rem;
          color: var(--text-primary);
          vertical-align: top;
        }
        body.dark .damage-entry-table th,
        body.dark .damage-entry-table td {
          color: #0f172a;
        }
        body.dark .damage-entry-table tr + tr td {
          border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .damage-entry-table tr + tr td {
          border-top: 1px solid var(--border-subtle);
        }
        .report-card {
          background: var(--card);
          border-radius: 0.75rem;
          box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
          padding: 1.25rem;
          margin-bottom: 1rem;
          border: 1px solid var(--border-subtle);
          color: var(--text-primary);
        }
        .report-card-header {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          align-items: flex-start;
          justify-content: space-between;
        }
        .report-card-meta {
          flex: 1 1 320px;
        }
        .report-card-top-row {
          display: block;
          margin-bottom: 0.5rem;
          text-align: center;
        }
        .report-card-meta {
          margin-bottom: 0.25rem;
          text-align: center;
        }
        .report-card-location-details {
          text-align: center;
        }
        .report-card-table-col {
          max-width: 360px;
          margin: 0 auto;
          padding: 0 0.5rem;
          text-align: center;
        }
        .report-card-body {
          display: flex;
          flex-wrap: wrap;
          gap: 1.5rem;
          margin-top: 1.25rem;
          justify-content: center;
        }
        .report-card-body__content {
          flex: 1 1 360px;
          min-width: 260px;
          text-align: center;
        }
        .report-filter-panel {
          background: var(--card);
          border: 1px solid var(--border-subtle);
          border-radius: 0.75rem;
          padding: 0.75rem 1rem;
          box-shadow: 0 8px 20px rgba(15, 34, 60, 0.08);
          max-width: 720px;
          margin: 0 auto;
        }
        .report-filter-panel .d-flex {
          justify-content: center;
        }
        .report-filter-panel .form-select {
          min-width: 220px;
        }
        .report-filter-chip {
          display: inline-flex;
          align-items: center;
          gap: 0.35rem;
          padding: 0.2rem 0.5rem;
          border-radius: 999px;
          border: 1px solid var(--border-subtle);
          background: var(--vin-box-bg);
          font-size: 0.85rem;
        }
        .report-filter-chip__label {
          margin-right: 0.25rem;
          font-weight: 600;
          color: var(--text-muted);
        }
        .report-filter-chip__input {
          border: none;
          background: transparent;
          min-width: 80px;
          padding: 0;
          font-size: 0.85rem;
        }
        .report-filter-chip__input:focus {
          outline: none;
          box-shadow: inset 0 0 0 1px var(--brand-accent);
          border-radius: 0.25rem;
          background: #fff;
          color: var(--text-primary);
        }
        .report-filter-chip .btn-close {
          padding: 0;
          width: 18px;
          height: 18px;
        }

        .report-date-scope {
          display: none;
          background: var(--card);
          border: 1px solid var(--border-subtle);
          border-radius: 0.75rem;
          padding: 0.75rem 0.9rem;
          box-shadow: 0 12px 32px rgba(15, 34, 60, 0.12);
          width: 100%;
          max-width: 640px;
          margin-top: 0.75rem;
        }
        .report-date-scope.expanded {
          display: block;
        }
        .report-date-scope-slider {
          height: 6px;
          border-radius: 999px;
          background: #c5d7ff;
          position: relative;
          overflow: hidden;
        }
        .report-date-scope-slider input[type="range"] {
          -webkit-appearance: none;
          appearance: none;
          width: 100%;
          padding: 0;
          margin: 0;
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          background: transparent;
          pointer-events: none;
        }
        .report-date-scope-slider input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 22px;
          height: 22px;
          border-radius: 50%;
          background: #0b5ed7;
          border: 3px solid #fff;
          box-shadow: 0 4px 10px rgba(11, 94, 215, 0.4);
          cursor: pointer;
          pointer-events: auto;
        }
        .report-date-scope-slider input[type="range"]::-moz-range-thumb {
          width: 22px;
          height: 22px;
          border-radius: 50%;
          background: #0b5ed7;
          border: 3px solid #fff;
          box-shadow: 0 4px 10px rgba(11, 94, 215, 0.4);
          cursor: pointer;
          pointer-events: auto;
        }
        .report-date-scope-slider input[type="range"]::-moz-range-track {
          background: transparent;
        }
        .report-date-scope-slider input[type="range"]:focus-visible {
          outline: none;
        }
        @media (max-width: 900px) {
          .report-card-body {
            flex-direction: column;
          }
          .report-card-top-row {
            flex-direction: column;
          }
          .report-card-table-col {
            max-width: 100%;
            justify-content: flex-start;
          }
        }
        .report-card-comment {
          margin: 0 0 0.5rem;
          text-align: center;
        }
        .report-actions {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
          align-items: center;
          justify-content: center;
        }
        .report-media-grid {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
          justify-content: center;
        }
        .report-media-img {
          height: 86px;
          width: auto;
          border-radius: 10px;
          object-fit: cover;
          border: 1px solid var(--border-subtle);
          background: var(--card);
          box-shadow: 0 2px 6px rgba(15, 34, 60, 0.1);
        }
        .report-media-img.report-media-img--splat {
          height: 140px;
          background: var(--card);
        }
        .damage-zone-collection {
          display: flex;
          flex-wrap: wrap;
          gap: 0.75rem;
        }
        .damage-zone-card {
          flex: 1 1 220px;
          min-width: 200px;
          border: 1px solid var(--border-subtle);
          border-radius: 0.75rem;
          background: var(--card);
          padding: 0.75rem;
          box-shadow: 0 4px 12px rgba(15, 34, 60, 0.05);
        }
        .damage-zone-card h6 {
          font-size: 0.95rem;
          margin: 0;
        }
        .damage-zone-card .badge {
          font-size: 0.75rem;
        }
        .branding-swatch {
          display: flex;
          align-items: center;
          gap: 0.45rem;
          font-size: 0.85rem;
          color: var(--text-muted);
        }
        .branding-swatch-dot {
          width: 22px;
          height: 22px;
          border-radius: 5px;
          border: 1px solid var(--border-subtle);
          display: inline-block;
          flex-shrink: 0;
        }
        .branding-preview-panel {
          border: 1px solid var(--border-subtle);
          border-radius: 1rem;
          padding: 1.25rem;
          background: var(--card);
          box-shadow: 0 12px 34px rgba(15, 34, 60, 0.08);
        }
        .branding-slider-control {
          display: grid;
          grid-template-columns: auto 1fr auto;
          gap: 0.75rem;
          align-items: center;
          margin-bottom: 0.75rem;
        }
        .branding-slider-control input[type="range"] {
          width: 100%;
        }
        .branding-preview-demo {
          border: 1px solid var(--border-subtle);
          border-radius: 1rem;
          padding: 1.25rem;
          background: var(--card);
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          transition: background-color 0.2s, border-color 0.2s;
        }
        #docudent {
          display: none;
        }
        .page-section#docudent.active {
          display: flex;
          flex-direction: column;
          flex: 1;
          width: 100%;
          height: 100%;
          min-height: calc(100vh - 4rem);
          margin: 0;
        }
        main.docu-fullscreen {
          padding: 0;
          height: calc(100vh - 4rem);
          display: flex;
          flex-direction: column;
        }
        .page-section#docudent.active .portal-iframe-wrapper {
          flex: 1;
          width: 100%;
          min-height: calc(100vh - 4rem);
          padding: 0;
          border-radius: 0;
          border: none;
          box-shadow: none;
          background: transparent;
          display: flex;
        }
        .page-section#docudent.active .portal-iframe-wrapper iframe {
          flex: 1;
          width: 100%;
          height: 100%;
          border: none;
          border-radius: 0;
        }
        .card-step.powerbi-embed {
          background: #f8fafc;
          border: 1px solid rgba(15, 23, 42, 0.1);
          box-shadow: 0 25px 60px rgba(15, 23, 42, 0.12);
        }
        .powerbi-embed-placeholder {
          padding: 0;
        }
        .branding-preview-title {
          font-weight: 600;
        }
        .branding-preview-button {
          border: none;
          padding: 0.55rem 1.25rem;
          border-radius: 10px;
          font-weight: 600;
          color: #fff;
          background: var(--brand-accent);
          cursor: pointer;
          align-self: flex-start;
          transition: transform 0.15s ease;
        }
        .branding-preview-button:active {
          transform: translateY(1px);
        }
        .vin-box {
          background: var(--vin-box-bg);
          border: 1px solid var(--vin-box-border);
          padding: 12px;
          border-radius: 8px;
        }
        .car-info {
          display: none;
          background: var(--card);
          border: 1px solid var(--border-subtle);
          border-radius: 10px;
          padding: 12px;
          margin-top: 10px;
        }
        .photo-preview img {
          height: 80px;
          border-radius: 8px;
          object-fit: cover;
          margin-right: 8px;
          margin-bottom: 8px;
          border: 1px solid var(--border-subtle);
        }
        .splat-preview-card {
          background: var(--card);
          border: 1px dashed var(--border-subtle);
          border-radius: 0.85rem;
          padding: 1.25rem;
          margin-top: 1.25rem;
        }
        .splat-chart-box {
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 320px;
          background: linear-gradient(
            135deg,
            rgba(15, 23, 42, 0.06),
            rgba(15, 23, 42, 0.03)
          );
          border-radius: 0.85rem;
          border: 1px solid rgba(148, 163, 184, 0.25);
          overflow: hidden;
          position: relative;
        }
        .splat-chart-box::after {
          content: "";
          position: absolute;
          inset: 0;
          border-radius: 0.85rem;
          pointer-events: none;
          box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.08);
        }
        .splat-chart-box img {
          max-width: 100%;
          height: auto;
          display: block;
          border-radius: 0.65rem;
          box-shadow: 0 10px 30px rgba(15, 23, 42, 0.18);
          background-color: #fff;
        }
        .splat-preview-empty {
          text-align: center;
          color: var(--text-muted);
          padding: 2rem 1rem;
        }
        .splat-preview-controls {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          align-items: center;
          margin-top: 1rem;
        }
        .splat-preview-controls .form-check {
          margin-bottom: 0;
        }
        .splat-preview-controls select {
          width: 220px;
        }
        .splat-chart-legend {
          display: flex;
          flex-wrap: wrap;
          gap: 0.6rem;
          margin-top: 1rem;
        }
        .splat-chart-legend span {
          display: inline-flex;
          align-items: center;
          gap: 0.4rem;
          border-radius: 999px;
          padding: 0.35rem 0.7rem;
          font-size: 0.85rem;
          border: 1px solid var(--vin-box-border);
          background: var(--vin-box-bg);
          color: #0f172a;
        }
        .splat-chart-legend span::before {
          content: "";
          width: 12px;
          height: 12px;
          border-radius: 50%;
          background: var(--severity-chip-color, currentColor);
          opacity: 0.35;
          box-shadow: 0 0 0 1px inset rgba(15, 23, 42, 0.1);
        }
        .damage-entry:not(:last-child) {
          border-bottom: 1px solid var(--border-subtle);
          padding-bottom: 1rem;
          margin-bottom: 1rem;
        }
        .remove-damage-entry {
          font-size: 0.875rem;
        }
        .fade-in {
          animation: fadeIn 0.35s ease-out;
        }
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(6px);
          }
          to {
            opacity: 1;
            transform: none;
          }
        }
        input,
        select,
        textarea {
          background-color: var(--input-bg);
          color: var(--text-primary);
          border-color: var(--input-border);
        }
        input::placeholder,
        textarea::placeholder {
          color: var(--text-muted);
          opacity: 1;
        }
        input.form-control[disabled] {
          background-color: var(--input-bg);
          color: var(--text-primary);
          opacity: 1;
        }
        label {
          color: var(--text-primary);
        }
        .bootstrap-select .dropdown-toggle {
          background-color: var(--input-bg);
          color: var(--text-primary);
          border-color: var(--input-border);
        }
        .bootstrap-select .dropdown-toggle:focus,
        .bootstrap-select .dropdown-toggle:hover {
          background-color: var(--input-bg);
          color: var(--text-primary);
          border-color: var(--brand-accent);
        }
        .bootstrap-select .dropdown-menu li {
          margin: 0;
        }
        .bootstrap-select .dropdown-menu li a {
          padding: 0.35rem 0.75rem;
          line-height: 1.35;
          white-space: normal;
        }
        .btn-outline-primary {
          color: var(--brand-accent);
          border-color: var(--brand-accent);
        }
        .btn-outline-primary:hover {
          background-color: var(--brand-accent);
          color: #fff;
        }
        .badge.bg-info {
          background-color: var(--brand-accent) !important;
          color: #fff !important;
        }
        .manual-override-field {
          border: 2px solid var(--manual-override-border) !important;
          background-color: var(--manual-override-bg) !important;
          box-shadow: 0 0 0 3px var(--manual-override-glow);
        }
        /* High-contrast Dark Mode via CSS variables */
        body.dark {
          --bg: #080d14;
          --card: #141c27;
          --sidebar-bg: #05080f;
          --sidebar-text: #dfe7f5;
          --sidebar-link: #aab5c8;
          --sidebar-link-hover: #ffffff;
          --text-primary: #f1f5ff;
          --text-muted: #9aa8bd;
          --border-subtle: #273344;
          --vin-box-bg: #1b2636;
          --vin-box-border: #31405a;
          --input-bg: #1c2534;
          --input-border: #344052;
          --manual-override-border: #f2b741;
          --manual-override-bg: rgba(242, 183, 65, 0.12);
          --manual-override-glow: rgba(242, 183, 65, 0.24);
        }
        body.dark .dropdown-menu {
          background-color: var(--card);
          color: var(--text-primary);
          border-color: var(--border-subtle);
        }
        body.dark .dropdown-item {
          color: var(--text-primary);
        }
        body.dark .dropdown-item:hover,
        body.dark .dropdown-item:focus {
          background-color: rgba(13, 110, 253, 0.2);
          color: var(--text-primary);
        }
        /* Optional font scaling */
        body.font-small {
          font-size: 0.9rem;
        }
        body.font-large {
          font-size: 1.2rem;
        }
        /* Color blindness friendly palettes */
        body.cb-protan {
          --brand: #00546e;
          --brand-accent: #1597d4;
          --sidebar-bg: #003a52;
        }
        body.cb-deutan {
          --brand: #2b4a6f;
          --brand-accent: #1cb0a6;
          --sidebar-bg: #213754;
        }
        body.cb-tritan {
          --brand: #2f3e8c;
          --brand-accent: #f18f01;
          --sidebar-bg: #252f6a;
        }
        /* Inline notification stack */
        #alertContainer {
          position: fixed;
          top: 1rem;
          right: 1rem;
          z-index: 1080;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          max-width: 360px;
        }
        .portal-alert {
          background-color: var(--card);
          color: var(--text-primary);
          border: 1px solid var(--border-subtle);
          box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
          margin: 0;
          border-left: 4px solid var(--brand-accent);
        }
        .portal-alert.alert-warning {
          border-left-color: #f7c948;
        }
        .portal-alert.alert-danger {
          border-left-color: #f15156;
        }
        .portal-alert.alert-success {
          border-left-color: #3fb950;
        }
        .portal-alert.alert-info {
          border-left-color: var(--brand-accent);
        }
        .portal-alert .btn-close {
          filter: invert(0.25);
        }
        body.dark .portal-alert .btn-close {
          filter: invert(1);
        }
          .portal-alert {
            width: 100%;
          }
        }
    </style>
    <link rel="stylesheet" href="/assets/css/responsive-fixes.css" />
</head>
<body>
<div id="alertContainer" aria-live="polite" aria-atomic="true"></div>
<div id="error-box" class="text-danger mt-3"></div>
<!-- Portal -->
<div id="portal" class="d-flex">
    <aside id="sidebar">
        <div id="sidebar-header">
            <img
                    id="sidebarLogo"
                    class="portal-logo"
                    src="/media/Nulane_Systems-removebg-preview-inv.png"
                    data-light-src="/media/Nulane_Systems-removebg-preview-inv.png"
                    data-dark-src="/media/Nulane_Systems-removebg-preview-inv.png"
                    alt="Nulane Logo"
            />
        </div>
        <div id="sidebar-content">
            <div class="sidebar-nav">
                <div class="nav-section-heading">Core</div>
                <a href="#" class="nav-link active" data-page="dashboard">
                    <span class="nav-link-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                    d="M3 12.5L12 5l9 7.5V20a1 1 0 0 1-1 1H15v-6H9v6H4a1 1 0 0 1-1-1Z"
                                    stroke="currentColor"
                                    stroke-width="1.8"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    fill="none"
                            />
                        </svg>
                    </span>
                    <span class="nav-link-label">Dashboard</span>
                </a>
                <a href="#" class="nav-link" data-page="reports">
                    <span class="nav-link-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                    d="M6 4h9l5 5v11a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1Z"
                                    stroke="currentColor"
                                    stroke-width="1.8"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    fill="none"
                            />
                            <path
                                    d="M9 11h6"
                                    stroke="currentColor"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                            />
                            <path
                                    d="M9 15h6"
                                    stroke="currentColor"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                            />
                        </svg>
                    </span>
                    <span class="nav-link-label">Reports</span>
                </a>
                <div class="nav-section-heading">Apps</div>
                <a href="#" class="nav-link" data-page="docudent">
                    <span class="nav-link-logo" aria-hidden="true">
                        <img src="/media/Docudent.png" alt="DocuDent logo" loading="lazy">
                    </span>
                    <span class="nav-link-label">DocuDent</span>
                </a>
                <div class="nav-section-heading">Settings</div>
                <a href="#" class="nav-link" data-page="settings">
                    <span class="nav-link-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                    d="M11.1 4.132a1 1 0 0 1 1.8 0l.256.936c.208.758.63 1.39 1.22 1.838l.84-.265a1 1 0 0 1 1.213.74l.26 1a1 1 0 0 1-.95 1.24l-.982.053a3.001 3.001 0 0 1 0 1.976l.982.053a1 1 0 0 1 .95 1.24l-.26 1a1 1 0 0 1-1.213.74l-.84-.265a3.003 3.003 0 0 1-1.22 1.338l-.256.936a1 1 0 0 1-1.8 0l-.256-.936a3.003 3.003 0 0 1-1.22-1.338l-.84.265a1 1 0 0 1-1.213-.74l-.26-1a1 1 0 0 1 .95-1.24l.982-.053a3.002 3.002 0 0 1 0-1.976l-.982-.053a1 1 0 0 1-.95-1.24l.26-1a1 1 0 0 1 1.213-.74l.84.265c.59-.448 1.012-1.08 1.22-1.838Z"
                                    stroke="currentColor"
                                    stroke-width="1.4"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    fill="none"
                            />
                            <circle
                                    cx="12"
                                    cy="12"
                                    r="2.5"
                                    stroke="currentColor"
                                    stroke-width="1.4"
                                    fill="none"
                            />
                        </svg>
                    </span>
                    <span class="nav-link-label">Settings</span>
                </a>
                <a
                        href="#"
                        id="facilitiesNavLink"
                        class="nav-link d-none"
                        data-page="facilities"
                >
                    <span class="nav-link-icon" aria-hidden="true">üè¢</span>
                    <span class="nav-link-label">Facilities</span>
                </a>
                <a
                        href="#"
                        id="brandingNavLink"
                        class="nav-link d-none"
                        data-page="branding"
                >
                    <span class="nav-link-icon" aria-hidden="true">üé®</span>
                    <span class="nav-link-label">Branding Studio</span>
                </a>
                <div
                        class="nav-section-heading d-none"
                        id="formsNavHeading"
                >
                    Acme Forms
                </div>
                <a
                        href="#"
                        id="formsNavLink"
                        class="nav-link d-none"
                        data-page="forms"
                >
                    <span class="nav-link-icon" aria-hidden="true">üìù</span>
                    <span class="nav-link-label">Acme Forms</span>
                </a>
                <hr />
            </div>
            <div class="sidebar-footer">
                <div class="powered-by-nulane-wrapper sidebar-powered">
                    <img
                        src="/media/powered_by_inv.png"
                        alt="Powered by Nulane"
                        loading="lazy"
                    />
                </div>
                <a href="#" id="logout" class="nav-link logout-link">
                    <span class="logout-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="3" width="12" height="18" rx="1.5" fill="#d32f2f" />
                            <line x1="9" y1="12" x2="13" y2="12" stroke="#fff" stroke-width="2" />
                            <path d="M13 9l3 3-3 3" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </span>
                    <span class="logout-label">Logout</span>
                </a>
            </div>
        </div>
    </aside>
    <main class="flex-grow-1 p-4">
        <!-- Dashboard -->
        <section id="dashboard" class="page-section active">
            <div class="text-center mb-3">
                <h3 class="fw-bold mb-0">Dashboard</h3>
            </div>
            <div id="powerbiCard" class="card-step powerbi-embed">
                <div id="powerbiEmbedContainer" class="powerbi-embed-placeholder">
                    <div id="powerbiEmbedRatio" class="ratio ratio-16x9">
                        <div
                                id="powerbiEmbedPlaceholderText"
                                class="text-center text-muted small d-flex align-items-center justify-content-center"
                        >
                            Fetching analytics‚Ä¶
                        </div>
                    </div>
                </div>
                <div
                        id="powerbiRestrictedMessage"
                        class="text-center text-muted mt-3 small d-none"
                >
                    <strong>Power BI access restricted</strong>
                    <p class="mb-0">
                        Analytics dashboards are available only to AWCT.inc or Inter-rail.inc tenants. Please contact support if you believe your organization should be granted access.
                    </p>
                </div>
            </div>
        </section>
        <section id="reports" class="page-section d-none">
            <div class="text-center mb-1">
                <h3 class="fw-bold mb-0">Reports</h3>
            </div>
            <p class="text-muted text-center mb-3">
                Review recent inspections submitted through DocuDent.
            </p>
            <div class="d-flex justify-content-center mb-3">
                <button id="refreshReportsBtn" class="btn btn-sm btn-outline-primary">
                    Refresh
                </button>
            </div>
            <h5 class="fw-semibold mt-3 text-center">Recent Reports</h5>
            <div id="reportFilterPanel" class="report-filter-panel mb-3">
            <div class="d-flex flex-wrap align-items-center justify-content-center gap-2">
                <span class="text-muted small mb-0">Filter by</span>
                <select id="reportFilterSelector" class="form-select form-select-sm">
                        <option value="">Choose a filter‚Ä¶</option>
                    </select>
                    <button
                        id="clearReportFiltersBtn"
                        type="button"
                        class="btn btn-sm btn-outline-secondary ms-auto d-none"
                    >
                        Clear filters
                    </button>
                </div>
                <div id="activeReportFilters" class="mt-2 d-flex flex-wrap gap-2"></div>
                <div id="adminUserFilterRow" class="mt-2 d-flex align-items-center gap-2 d-none">
                    <span class="text-muted small mb-0">Filter by user</span>
                    <select id="adminUserFilterSelect" class="form-select form-select-sm w-auto"></select>
                </div>
                <div id="reportDateScope" class="report-date-scope" aria-hidden="true">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small mb-0">Timeline</span>
                        <span class="text-muted small mb-0">Drag to narrow</span>
                    </div>
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-3">
                            <div>
                                <div class="small text-muted mb-1">Start</div>
                                <input
                                    id="reportDateStartInput"
                                    class="form-control form-control-sm"
                                    type="datetime-local"
                                />
                            </div>
                            <div>
                                <div class="small text-muted mb-1">End</div>
                                <input
                                    id="reportDateEndInput"
                                    class="form-control form-control-sm"
                                    type="datetime-local"
                                />
                            </div>
                        </div>
                        <div class="report-date-scope-slider position-relative my-1">
                            <input
                                id="reportDateStartRange"
                                type="range"
                                min="0"
                                step="1"
                                value="0"
                            />
                            <input
                                id="reportDateEndRange"
                                type="range"
                                min="0"
                                step="1"
                                value="0"
                            />
                        </div>
                        <div class="small text-muted">
                            Controls snap to timestamps already present in this view.
                        </div>
                    </div>
                </div>
            </div>
            <div id="reportsContainer" class="mt-3"></div>
        </section>
        <section id="facilities" class="page-section d-none">
            <div class="text-center mb-3">
                <h3 class="fw-bold mb-0">Facilities</h3>
            </div>
            <p class="text-muted text-center mb-4">
                Add or update the organization locations that inspectors see when assigning bays and navigation guidance.
            </p>
            <div id="facilitiesStatus" class="text-muted small mb-3"></div>
            <div id="facilitiesList" class="mb-4"></div>
            <form id="facilityForm" class="row g-3">
                <input type="hidden" id="facilityId" value="" />
                <input type="hidden" id="facilitySlug" value="" />
                <div class="col-md-6">
                    <label for="facilityName" class="form-label">Facility name</label>
                    <input
                            type="text"
                            id="facilityName"
                            class="form-control"
                            placeholder="Full facility or bay name"
                            required
                    />
                </div>
                <div class="col-md-6">
                    <label for="facilityLabel" class="form-label">Label / bay identifier</label>
                    <input
                            type="text"
                            id="facilityLabel"
                            class="form-control"
                            placeholder="Short label (e.g. Bay 4)"
                    />
                </div>
                <div class="col-12">
                    <label for="facilityNotes" class="form-label">Notes</label>
                    <textarea
                            id="facilityNotes"
                            class="form-control"
                            rows="2"
                            placeholder="Optional navigation instructions or reminders"
                    ></textarea>
                </div>
                <div class="col-md-4">
                    <label for="facilityActive" class="form-label">Status</label>
                    <select id="facilityActive" class="form-select">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="col-12 d-flex flex-wrap gap-2 align-items-center">
                    <button type="submit" class="btn btn-primary">Save facility</button>
                    <button type="button" class="btn btn-outline-secondary" id="facilityFormResetBtn">
                        Reset form
                    </button>
                    <span id="facilityFormStatus" class="small text-muted"></span>
                </div>
            </form>
        </section>
        <!-- DocuDent embed -->
        <section id="docudent" class="page-section">
            <div class="portal-iframe-wrapper">
                <iframe
                        src="app/index.html"
                        title="DocuDent damage submission"
                        loading="lazy"
                ></iframe>
            </div>
        </section>
        <section id="docufit" class="page-section d-none">
            <div class="d-flex align-items-start justify-content-between mb-3 gap-3">
                <div>
                    <h3 class="mb-1">DocuFit</h3>
                    <p class="text-muted mb-0">
                        Multi-tenant milestone tracking that routes uploads, milestone events, and emails back to DocuDent based on the tenant scope.
                    </p>
                </div>
                <button
                        id="refreshDocuFitStatusBtn"
                        type="button"
                        class="btn btn-outline-primary btn-sm align-self-start"
                >
                    Refresh status
                </button>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-lg-6">
                    <div class="card-step h-100">
                        <h5>DocuFit health</h5>
                        <p class="text-muted small mb-2">
                            Base URL: <code id="docufitBaseLabel">/docufit</code>
                        </p>
                        <div id="docufitHealthStatus" class="fw-semibold">Waiting for service check‚Ä¶</div>
                        <div id="docufitHealthDetail" class="text-muted small" aria-live="polite"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card-step h-100">
                        <h5>Key endpoints</h5>
                        <ul class="list-group list-group-flush" id="docufitEndpointList">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>GET /docufit/health</span>
                                <span class="badge bg-success">Public</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>POST /docufit/api/milestones</span>
                                <span class="badge bg-primary">Protected</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>POST /docufit/api/uploads</span>
                                <span class="badge bg-primary">Protected</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>POST /docufit/api/email</span>
                                <span class="badge bg-info">Proxy</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-step mb-3">
                <h5>Tenant experience</h5>
                <p class="text-muted small mb-2">
                    The portal listens to your Auth0 profile to surface the app that matters. Manually pin an experience below while the tenant detection matures.
                </p>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label mb-1" for="tenantExperienceSelect">Preferred experience</label>
                        <select id="tenantExperienceSelect" class="form-select">
                            <option value="auto">Auto-detect (recommended)</option>
                            <option value="docudent">DocuDent + reporting</option>
                        </select>
                        <div class="form-text small text-muted mt-1">
                            Preference is stored locally; switch back to auto once you return to mixed tenant work.
                        </div>
                    </div>
                    <div class="col-md-6">
                        <p class="form-label mb-1 text-muted">Active experience</p>
                        <div id="tenantExperienceBadge" class="badge bg-secondary">
                            Awaiting selection‚Ä¶
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-step">
                <h5>DocuFit sync notes</h5>
                <p class="text-muted small mb-2">
                    DocuFit persists milestone snapshots in its own schema while proxying email, uploads, and DocuDent branding. Each tenant receives a tailored experience based on the tenant metadata attached to the Auth0 token.
                </p>
                <ul class="list-unstyled mb-0">
                    <li class="small mb-1">‚Ä¢ Milestone ingestion goes through <code>/docufit/api/milestones</code> and mirrors into DocuDent for reporting.</li>
                    <li class="small mb-1">‚Ä¢ Upload routes are available at <code>/docufit/api/uploads</code>; they carry the same Auth0 token as the portal.</li>
                    <li class="small mb-1">‚Ä¢ User metadata from the portal determines which app tabs, logos, and API keys are shown.</li>
                </ul>
            </div>
        </section>
        <!-- Settings -->
        <section id="settings" class="page-section">
            <h3>Settings</h3>
            <p class="text-muted">Customize your experience below.</p>
            <div class="card-step">
                <h5>Theme</h5>
                <div class="btn-group" role="group">
                    <input
                            type="radio"
                            class="btn-check"
                            name="themeMode"
                            id="theme-light"
                            value="light"
                            autocomplete="off"
                    />
                    <label class="btn btn-outline-primary" for="theme-light">Light</label>
                    <input
                            type="radio"
                            class="btn-check"
                            name="themeMode"
                            id="theme-dark"
                            value="dark"
                            autocomplete="off"
                    />
                    <label class="btn btn-outline-primary" for="theme-dark">Dark</label>
                    <input
                            type="radio"
                            class="btn-check"
                            name="themeMode"
                            id="theme-system"
                            value="system"
                            autocomplete="off"
                    />
                    <label class="btn btn-outline-primary" for="theme-system">System</label>
                </div>
            </div>
            <div class="card-step">
                <h5>Font Size</h5>
                <select id="fontSize" class="form-select" style="max-width: 250px">
                    <option value="small">Small</option>
                    <option value="default" selected>Default</option>
                    <option value="large">Large</option>
                </select>
            </div>
            <div class="card-step">
                <h5>Color Blindness Mode</h5>
                <select id="colorBlindMode" class="form-select" style="max-width: 300px">
                    <option value="none" selected>None</option>
                    <option value="protan">Protanopia (Red Weak)</option>
                    <option value="deutan">Deuteranopia (Green Weak)</option>
                    <option value="tritan">Tritanopia (Blue Weak)</option>
                </select>
            </div>
            <div class="card-step">
                <h5>Account</h5>
                <button id="deleteAccountBtn" class="btn btn-outline-danger">
                    Delete My Account
                </button>
            </div>
            <div class="mt-3">
                <a href="#" id="tosLink" class="btn btn-link">View Terms of Service</a>
            </div>
        </section>
        <section id="branding" class="page-section d-none">
            <h3>Branding Studio</h3>
            <p class="text-muted">
                Paid organizations can update their logo and color palette so reports and emails stay on brand.
            </p>
            <div class="card-step">
                <form id="brandingForm" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Brand Name</label>
                        <input
                                type="text"
                                id="brandingName"
                                class="form-control branding-field"
                                placeholder="Organization / product name"
                                data-field="organization_name"
                        />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Organization Logo (SVG/PNG)</label>
                        <input
                                type="file"
                                id="brandingLogoInput"
                                class="form-control"
                                accept="image/*"
                        />
                        <div id="brandingLogoStatus" class="small text-muted mt-1">
                            Upload a transparent PNG or SVG that will appear in reports and emails.
                        </div>
                        <img
                                id="brandingLogoPreview"
                                class="mt-2"
                                alt="Logo preview"
                                style="max-height:80px;border:1px solid var(--border-subtle);padding:8px;border-radius:8px;display:block;object-fit:contain;"
                                hidden
                        />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Primary Color</label>
                        <input
                                type="color"
                                id="brandingPrimaryColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="primary_color"
                                data-label="Primary"
                        />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Secondary Color</label>
                        <input
                                type="color"
                                id="brandingSecondaryColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="secondary_color"
                                data-label="Secondary"
                        />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Accent Color</label>
                        <input
                                type="color"
                                id="brandingAccentColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="accent_color"
                                data-label="Accent"
                        />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Action Button Color</label>
                        <input
                                type="color"
                                id="brandingButtonColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="button_color"
                                data-label="Button"
                        />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Background Color</label>
                        <input
                                type="color"
                                id="brandingBackgroundColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="background_color"
                                data-label="Background"
                        />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Text Color</label>
                        <input
                                type="color"
                                id="brandingTextColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="text_color"
                                data-label="Text"
                        />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Border / Divider</label>
                        <input
                                type="color"
                                id="brandingBorderColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="border_color"
                                data-label="Border"
                        />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Accent Status Color</label>
                        <input
                                type="color"
                                id="brandingErrorColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="error_color"
                                data-label="Error"
                        />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Success Color</label>
                        <input
                                type="color"
                                id="brandingSuccessColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="success_color"
                                data-label="Success"
                        />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Warning Color</label>
                        <input
                                type="color"
                                id="brandingWarningColor"
                                class="form-control form-control-color branding-color-input"
                                data-field="warning_color"
                                data-label="Warning"
                        />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Font Family</label>
                        <select
                                id="brandingFontFamily"
                                class="form-select branding-field"
                                data-field="font_family"
                        >
                            <option value="Inter">Inter</option>
                            <option value="Space Grotesk">Space Grotesk</option>
                            <option value="Montserrat">Montserrat</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Poppins">Poppins</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Company Address</label>
                        <input
                                type="text"
                                id="brandingCompanyAddress"
                                class="form-control branding-field"
                                placeholder="123 Main St, Suite 100"
                                data-field="company_address"
                        />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Company Phone</label>
                        <input
                                type="text"
                                id="brandingCompanyPhone"
                                class="form-control branding-field"
                                placeholder="(555) 555-0123"
                                data-field="company_phone"
                        />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Company Email</label>
                        <input
                                type="email"
                                id="brandingCompanyEmail"
                                class="form-control branding-field"
                                placeholder="support@example.com"
                                data-field="company_email"
                        />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Website URL</label>
                        <input
                                type="url"
                                id="brandingWebsiteUrl"
                                class="form-control branding-field"
                                placeholder="https://example.com"
                                data-field="website_url"
                        />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Powered By Logo URL</label>
                        <input
                                type="url"
                                id="brandingPoweredByLogo"
                                class="form-control branding-field"
                                placeholder="https://nulanesystems.com/assets/powered-by.png"
                                data-field="powered_by_logo_path"
                        />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email Signature</label>
                        <textarea
                                id="brandingEmailSignature"
                                class="form-control branding-field"
                                rows="3"
                                placeholder="Thanks,&#10;The Team"
                                data-field="email_signature"
                        ></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email Footer</label>
                        <textarea
                                id="brandingEmailFooter"
                                class="form-control branding-field"
                                rows="3"
                                placeholder="Confidentiality notice..."
                                data-field="email_footer"
                        ></textarea>
                    </div>
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input
                                    class="form-check-input branding-field"
                                    type="checkbox"
                                    role="switch"
                                    id="brandingDarkMode"
                                    data-field="is_dark_mode"
                            />
                            <label class="form-check-label" for="brandingDarkMode">
                                Treat colors as a dark-mode brand (flips text/background logic)
                            </label>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="branding-preview-panel">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <strong>Live preview</strong>
                                    <div class="text-muted small">Adjust sliders to feel different spacing and button shapes.</div>
                                </div>
                                <div class="small text-muted" id="brandingOrganizationInfo"></div>
                            </div>
                            <div class="branding-slider-control">
                                <label for="brandingPreviewSpacing" class="mb-0">Card padding</label>
                                <input
                                        type="range"
                                        id="brandingPreviewSpacing"
                                        min="6"
                                        max="40"
                                        value="18"
                                        step="1"
                                />
                                <span id="brandingPreviewSpacingValue" class="text-nowrap fw-semibold">18px</span>
                            </div>
                            <div class="branding-slider-control">
                                <label for="brandingButtonRadius" class="mb-0">Button roundness</label>
                                <input
                                        type="range"
                                        id="brandingButtonRadius"
                                        min="0"
                                        max="32"
                                        value="10"
                                        step="1"
                                />
                                <span id="brandingButtonRadiusValue" class="text-nowrap fw-semibold">10px</span>
                            </div>
                            <div id="brandingPreviewDemo" class="branding-preview-demo">
                                <div id="brandingDemoTitle" class="branding-preview-title">Branding quick peek</div>
                                <p id="brandingDemoText" class="mb-0">
                                    Colors feed this summary, so you can see how buttons, text, and surfaces stack in emails.
                                </p>
                                <button id="brandingDemoButton" type="button" class="branding-preview-button">
                                    Try this action
                                </button>
                            </div>
                        </div>
                    </div>
                    <input
                            type="hidden"
                            id="brandingCustomThemeData"
                            class="branding-field"
                            data-field="custom_theme_data"
                            data-parse="json"
                            value="{}"
                    />
                    <input
                            type="hidden"
                            id="brandingEmailTemplates"
                            class="branding-field"
                            data-field="email_templates"
                            data-parse="json"
                            value="{}"
                    />
                    <div class="col-12">
                        <div id="brandingPreviewSwatch" class="d-flex flex-wrap gap-3 mt-2"></div>
                        <div class="small text-muted" id="brandingUpdatedAtLabel">
                            Last saved: <span id="brandingUpdatedAt">‚Äî</span>
                        </div>
                    </div>
                    <div class="col-12 d-flex align-items-center gap-3">
                        <button id="brandingSaveBtn" type="submit" class="btn btn-primary">
                            Save Branding
                        </button>
                        <span id="brandingSaveStatus" class="small text-muted"></span>
                    </div>
                </form>
            </div>
        </section>
        <section id="forms" class="page-section d-none">
            <div class="text-center mb-3">
                <h3 class="fw-bold mb-0">Acme Inc Forms</h3>
                <p class="text-muted mb-0">
                    Secure workflow forms for Acme.inc operations.
                </p>
            </div>
            <div class="card card-step">
                <div id="acmeFormContainer" class="acme-forms-embed">
                    <div class="text-center text-muted small">
                        Loading Acme workflow form...
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<div
        class="modal fade"
        id="portalPromoModal"
        tabindex="-1"
        aria-labelledby="portalPromoModalLabel"
        aria-hidden="true"
>
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="portalPromoForm">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="portalPromoModalLabel">
                        Unlock portal access
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">
                        Enter your promo code to grant Basic-tier portal access for your organization.
                    </p>
                    <div class="mb-3">
                        <label for="portalPromoCodeInput" class="form-label">Promo code</label>
                        <input
                                type="text"
                                id="portalPromoCodeInput"
                                class="form-control"
                                autocomplete="off"
                                placeholder="Enter promo code"
                        />
                    </div>
                    <div id="portalPromoStatus" class="form-text text-muted"></div>
                </div>
                <div class="modal-footer">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                    >
                        Close
                    </button>
                    <button type="submit" class="btn btn-primary" id="applyPromoCodeBtn">
                        Apply code
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- JS: jQuery, Bootstrap, Bootstrap Select -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.6/auth0-spa-js.production.js"></script>
<script>
    class SplatChartGenerator {
        constructor() {}
        async generatePng() {
            return { png: "", svg: "", warnings: [] };
        }
    }

    function createMailgunClient() {
        return async () => {};
    }

    const DEFAULT_API_BASE = "https://api.nulanesystems.com/api";
    const DEFAULT_DOCUFIT_API_BASE = "/docufit";

    function normalizeBaseUrl(value) {
      if (!value || typeof value !== "string") return null;
      const trimmed = value.trim();
      if (!trimmed) return null;
      return trimmed.replace(/\/+$/, "");
    }

    function resolveApiBase() {
      const globalOverride =
        window.__DOCUDENT_API_BASE || window.DOCUDENT_API_BASE;
      const htmlDataset =
        document.documentElement?.dataset?.apiBase ||
        document.documentElement?.getAttribute?.("data-api-base");
      const scriptDataset =
        document.currentScript?.dataset?.apiBase ||
        document.currentScript?.getAttribute?.("data-api-base");

      const candidates = [
        normalizeBaseUrl(globalOverride),
        normalizeBaseUrl(htmlDataset),
        normalizeBaseUrl(scriptDataset),
      ].filter(Boolean);

      for (const candidate of candidates) {
        if (candidate) {
          return candidate;
        }
      }

      if (typeof window !== "undefined" && window.location) {
        const { origin, hostname } = window.location;
        const normalizedOrigin = normalizeBaseUrl(origin);
        if (
          hostname &&
          /^(localhost|127\.|0\.0\.0\.0)$/i.test(hostname)
        ) {
          return normalizedOrigin ? `${normalizedOrigin}/api` : DEFAULT_API_BASE;
        }
        if (hostname && hostname.endsWith(".internal")) {
          return normalizedOrigin ? `${normalizedOrigin}/api` : DEFAULT_API_BASE;
        }
        if (
          hostname &&
          hostname.toLowerCase().endsWith("nulanesystems.com")
        ) {
          return DEFAULT_API_BASE;
        }
        if (normalizedOrigin) {
          return `${normalizedOrigin}/api`;
        }
      }

      return DEFAULT_API_BASE;
    }

    function deriveDocuFitBaseFromApiBase(value) {
      if (!value) return null;
      const normalized = normalizeBaseUrl(value);
      if (!normalized) return null;
      if (normalized.endsWith("/api")) {
        return `${normalized.slice(0, -4)}/docufit`;
      }
      const apiIndex = normalized.indexOf("/api/");
      if (apiIndex >= 0) {
        return `${normalized.slice(0, apiIndex)}/docufit${normalized.slice(apiIndex + 4)}`;
      }
      return `${normalized}/docufit`;
    }

    function resolveDocuFitBase(apiBase) {
      const globalOverride =
        window.__DOCUFIT_API_BASE || window.DOCUFIT_API_BASE;
      const htmlDataset =
        document.documentElement?.dataset?.docufitApiBase ||
        document.documentElement?.getAttribute?.("data-docufit-api-base");
      const scriptDataset =
        document.currentScript?.dataset?.docufitApiBase ||
        document.currentScript?.getAttribute?.("data-docufit-api-base");

      const candidates = [
        normalizeBaseUrl(globalOverride),
        normalizeBaseUrl(htmlDataset),
        normalizeBaseUrl(scriptDataset),
        deriveDocuFitBaseFromApiBase(apiBase),
      ].filter(Boolean);

      for (const candidate of candidates) {
        if (candidate) {
          return candidate;
        }
      }

      return DEFAULT_DOCUFIT_API_BASE;
    }

    const domain = "nulanesystems.us.auth0.com";
    const clientId = "WkYT29HkNJo5rjDMPGTxAdb04QdKQsPc";
    const redirectUri = "https://nulanesystems.com/portal";
    const audience = "https://api.nulanesystems.com";
    const apiBase = resolveApiBase();
    window.__DOCUDENT_API_BASE_RESOLVED = apiBase;
    const TENANT_PREFERENCE_KEY = "portalTenantExperience";
    const docuFitApiBase = resolveDocuFitBase(apiBase);
    window.__DOCUFIT_API_BASE_RESOLVED = docuFitApiBase;
    const APP_ORIGIN_DOCUDENT = 1;
    const APP_ORIGIN_DOCUFIT = 2;
    const APP_ORIGIN_ALIAS_MAP = {
      docudent: APP_ORIGIN_DOCUDENT,
      docufit: APP_ORIGIN_DOCUFIT,
    };
    const AWCT_POWERBI_EMBED_URL =
      "https://app.powerbi.com/view?r=eyJrIjoiYThlNTY0ZmItMDE4NS00MjY2LTk1NWMtZDg1OWY2ZjI3MTBlIiwidCI6IjUxZjU3NDU4LTQ5YzQtNDQ1NC1hNDQ1LWFmYTE4OTAxNTUxYyJ9";
    const INTER_RAIL_POWERBI_EMBED_URL =
      "https://app.powerbi.com/view?r=eyJrIjoiYTg1OTcyYjMtNGRiYy00ODNmLWI3ODctYzU0NmU0ZTg1ODM2IiwidCI6IjUxZjU3NDU4LTQ5YzQtNDQ1NC1hNDQ1LWFmYTE4OTAxNTUxYyJ9";
    const APP_NAV_BLUEPRINTS = [
      { page: "docudent", originBit: APP_ORIGIN_DOCUDENT },
    ];
    const RESTRICTED_APP_TIERS = new Set(["free-tier"]);
    const PORTAL_REQUEST_HEADER = "X-Portal-Request";
    const MAX_DAMAGE_ENTRIES = 5;
    const COLOR_BLIND_CLASSES = ["cb-protan", "cb-deutan", "cb-tritan"];
    const ACME_FORM_EMBED_SCRIPT_URL =
      "https://fs8.formsite.com/include/form/embedManager.js?186144419";
    const ACME_FORM_EMBED_KEY =
      "https://fs8.formsite.com/res/showFormEmbed?EParam=bJeI6E3QIKDfMjkck8JuwNt7h1SghSJ6&186144419";
    const SEVERITY_LABELS = {
      1: '1 - ‚â§1" (‚â§3 cm)',
      2: '2 - >1" to ‚â§3" (3‚Äì8 cm)',
      3: '3 - >3" to ‚â§6" (8‚Äì15 cm)',
      4: '4 - >6" to ‚â§12" (15‚Äì30 cm)',
      5: '5 - >12" (‚â•30 cm)',
      6: "6 - Missing / Major Damage",
    };
      const SEVERITY_COLORS = {
        1: "#22C55E",
        2: "#EAB308",
        3: "#F97316",
        4: "#EF4444",
        5: "#991B1B",
        6: "#111827",
      };
    let auth0Client = null;
    let accessToken = null;
    let portalInitialized = false;
    let tokenExpiryTimer = null;
    let currentUserProfile = null;
    let currentOrganizationProfile = null;
    let isAdminUser = false;
    let isOrgAdminUser = false;
    let isPaidOrganization = false;
    let portalAccessGranted = false;
    let currentPlanTier = "";
    let organizationIdForBranding = "";
    let brandingPanelLoaded = false;
    let brandingPanelLoading = false;
    let currentLogoUrl = "";
    let tenantExperiencePreference = "auto";
    let acmeFormScriptInjected = false;
    let acmeFormEmbedRendered = false;
    const alertContainer = document.getElementById("alertContainer");
    const loginButton = document.getElementById("loginButton");
    const portal = document.getElementById("portal");
    const reportsContainer = document.getElementById("reportsContainer");
    const errorBox = document.getElementById("error-box");
    const powerbiEmbedRatio = document.getElementById("powerbiEmbedRatio");
    const powerbiRestrictedMessage = document.getElementById("powerbiRestrictedMessage");
    const promoOfferPanel = document.getElementById("promoOfferPanel");
    const openPromoModalBtn = document.getElementById("openPromoModalBtn");
    const portalPromoModalElement = document.getElementById("portalPromoModal");
    const portalPromoForm = document.getElementById("portalPromoForm");
    const portalPromoCodeInput = document.getElementById("portalPromoCodeInput");
    const portalPromoStatus = document.getElementById("portalPromoStatus");
    const applyPromoCodeBtn = document.getElementById("applyPromoCodeBtn");
    const portalPromoModalInstance =
      portalPromoModalElement &&
      typeof bootstrap !== "undefined" &&
      bootstrap.Modal
        ? new bootstrap.Modal(portalPromoModalElement, { backdrop: "static" })
        : null;
    const setPortalPromoStatusText = (text) => {
      if (portalPromoStatus) {
        portalPromoStatus.textContent = text;
      }
    };
    const damageForm = document.getElementById("damageForm");
    const damageResult = document.getElementById("damageResult");
    const refreshBtn = document.getElementById("refreshReportsBtn");
    const logoutBtn = document.getElementById("logout");
    const vinInput = document.getElementById("vinInput");
    const vinStatus = document.getElementById("vinStatus");
    const decodeBtn = document.getElementById("decodeVinBtn");
    const decodeLabel = decodeBtn?.querySelector(".decode-label");
    const decodeSpin = decodeBtn?.querySelector(".decode-spinner");
    const carInfoBox = document.getElementById("carInfo");
    const carMake = document.getElementById("carMake");
    const carModel = document.getElementById("carModel");
    const carYear = document.getElementById("carYear");
    const carTrimEngine = document.getElementById("carTrimEngine");
    const vinField = document.getElementById("vin");
    const makeField = document.getElementById("make");
    const modelField = document.getElementById("model");
    const yearField = document.getElementById("year");
    const vinVisible = document.getElementById("vinVisible");
    const makeVisible = document.getElementById("makeVisible");
    const modelVisible = document.getElementById("modelVisible");
    const yearVisible = document.getElementById("yearVisible");
    const manualOverrideToggle = document.getElementById("manualOverrideToggle");
    const manualOverrideHelp = document.getElementById("manualOverrideHelp");
    const photosInput = document.getElementById("photos");
    const photoPreview = document.getElementById("photoPreview");
    const uploadProgressWrap = document.getElementById("uploadProgressWrap");
    const uploadProgress = document.getElementById("uploadProgress");
    const uploadNote = document.getElementById("uploadNote");
    const damageEntriesContainer = document.getElementById("damageEntriesContainer");
    const addDamageEntryBtn = document.getElementById("addDamageEntryBtn");
    const damageEntryTemplate = document.getElementById("damage-entry-template");
    const splatChartBox = document.getElementById("splatChartBox");
    const splatLegend = document.getElementById("splatLegend");
    const splatZoneSelect = document.getElementById("splatZoneSelect");
    const splatLabelsToggle = document.getElementById("toggleSplatLabels");
    const splatChartInput = document.getElementById("splatChartPngInput");
    const splatChartSvgInput = document.getElementById("splatChartSvgInput");
    const refreshSplatBtn = document.getElementById("refreshSplatBtn");
    const fontSizeSelect = document.getElementById("fontSize");
    const colorBlindSelect = document.getElementById("colorBlindMode");
    const brandingNavLink = document.getElementById("brandingNavLink");
    const brandingSection = document.getElementById("branding");
    const facilitiesNavLink = document.getElementById("facilitiesNavLink");
    const facilitiesSection = document.getElementById("facilities");
    const facilitiesStatus = document.getElementById("facilitiesStatus");
    const facilitiesList = document.getElementById("facilitiesList");
    const facilityForm = document.getElementById("facilityForm");
    const facilityIdInput = document.getElementById("facilityId");
    const facilitySlugInput = document.getElementById("facilitySlug");
    const facilityNameInput = document.getElementById("facilityName");
    const facilityLabelInput = document.getElementById("facilityLabel");
    const facilityNotesInput = document.getElementById("facilityNotes");
    const facilityActiveSelect = document.getElementById("facilityActive");
    const facilityFormStatus = document.getElementById("facilityFormStatus");
    const facilityFormResetBtn = document.getElementById("facilityFormResetBtn");
    const brandingForm = document.getElementById("brandingForm");
    const brandingNameInput = document.getElementById("brandingName");
    const brandingLogoInput = document.getElementById("brandingLogoInput");
    const brandingLogoPreview = document.getElementById("brandingLogoPreview");
    const brandingLogoStatus = document.getElementById("brandingLogoStatus");
    const brandingColorInputs = document.querySelectorAll(".branding-color-input");
    const brandingPreviewSwatch = document.getElementById("brandingPreviewSwatch");
    const brandingSaveBtn = document.getElementById("brandingSaveBtn");
    const brandingSaveStatus = document.getElementById("brandingSaveStatus");
    const brandingFields = document.querySelectorAll(".branding-field");
    const brandingPreviewSpacing = document.getElementById("brandingPreviewSpacing");
    const brandingPreviewSpacingValue = document.getElementById("brandingPreviewSpacingValue");
    const brandingButtonRadius = document.getElementById("brandingButtonRadius");
    const brandingButtonRadiusValue = document.getElementById("brandingButtonRadiusValue");
    const brandingPreviewDemo = document.getElementById("brandingPreviewDemo");
    const brandingDemoText = document.getElementById("brandingDemoText");
    const brandingDemoButton = document.getElementById("brandingDemoButton");
    const brandingOrganizationInfo = document.getElementById("brandingOrganizationInfo");
    const brandingUpdatedAt = document.getElementById("brandingUpdatedAt");
    const brandingCustomThemeDataInput = document.getElementById("brandingCustomThemeData");
    const brandingEmailTemplatesInput = document.getElementById("brandingEmailTemplates");
    const portalLogos = document.querySelectorAll(".portal-logo");
    const dashboardNavLink = document.querySelector('[data-page="dashboard"]');
    const dashboardSection = document.getElementById("dashboard");
    const formsNavHeading = document.getElementById("formsNavHeading");
    const formsNavLink = document.getElementById("formsNavLink");
    const formsSection = document.getElementById("forms");
    const acmeFormContainer = document.getElementById("acmeFormContainer");
    const AWCT_ALLOWED_ORG = "awct.inc";
    const INTER_RAIL_ALLOWED_ORG = "inter-rail.inc";
    const ACME_ALLOWED_ORG = "acme.inc";
    const ACME_ALLOWED_ORG_ID = "baa50da7-b31d-440c-804c-034849c33dea";
    const PORTAL_LOGO_DEFAULT_PATH = "/media/Nulane_Systems-removebg-preview-inv.png";
    const PORTAL_LOGO_AWCT_PATH = "/media/AWCT.png";
    const PORTAL_LOGO_IRT_PATH = "/media/IRT-Navigation-LOGO.png";
    const CUSTOM_ORG_LOGOS = {
      [AWCT_ALLOWED_ORG]: PORTAL_LOGO_AWCT_PATH,
      [INTER_RAIL_ALLOWED_ORG]: PORTAL_LOGO_IRT_PATH,
    };
    const portalLogoDefaults = new WeakMap();
    portalLogos?.forEach((img) => {
      if (!img) return;
      const light = img.dataset.lightSrc || img.getAttribute("src") || PORTAL_LOGO_DEFAULT_PATH;
      const dark =
        img.dataset.darkSrc || img.dataset.lightSrc || img.getAttribute("src") || PORTAL_LOGO_DEFAULT_PATH;
      portalLogoDefaults.set(img, { light, dark });
    });
    const sidebarHeader = document.getElementById("sidebar-header");
    const mainContent = document.querySelector("main");
    const appNavEntries = APP_NAV_BLUEPRINTS.map((entry) => ({
      ...entry,
      navLink: document.querySelector(`.nav-link[data-page="${entry.page}"]`),
      section: document.getElementById(entry.page),
    }));
    let currentAppOriginMask = APP_ORIGIN_DOCUDENT;
    const refreshDocuFitStatusBtn = document.getElementById("refreshDocuFitStatusBtn");
    const docufitHealthStatus = document.getElementById("docufitHealthStatus");
    const docufitHealthDetail = document.getElementById("docufitHealthDetail");
    const docufitBaseLabel = document.getElementById("docufitBaseLabel");
    const tenantExperienceSelect = document.getElementById("tenantExperienceSelect");
    const tenantExperienceBadge = document.getElementById("tenantExperienceBadge");
    if (docufitBaseLabel) {
      docufitBaseLabel.textContent = docuFitApiBase;
    }
    tenantExperiencePreference = loadTenantExperiencePreference();
    const sidebarToggle = document.getElementById("sidebarToggle");
    const sidebarCollapseStorageKey = "portalSidebarCollapsed";
    const reportFilterSelector = document.getElementById("reportFilterSelector");
    const activeReportFilters = document.getElementById("activeReportFilters");
    const clearReportFiltersBtn = document.getElementById("clearReportFiltersBtn");
    const adminUserFilterRow = document.getElementById("adminUserFilterRow");
    const adminUserFilterSelect = document.getElementById("adminUserFilterSelect");
    const TIMELINE_FILTER_KEY = "timeline";
    const REPORT_FILTER_OPTIONS = [
      { key: TIMELINE_FILTER_KEY, label: "Timeline" },
      { key: "report_id", label: "Report ID", placeholder: "Enter report ID" },
      { key: "vin", label: "VIN", placeholder: "Enter VIN" },
      { key: "make", label: "Make", placeholder: "Enter make" },
      { key: "model", label: "Model", placeholder: "Enter model" },
      {
        key: "inspector_email",
        label: "Inspector Email",
        placeholder: "Enter inspector email",
      },
      { key: "status", label: "Status", placeholder: "Enter status" },
      { key: "year", label: "Year", placeholder: "Enter year", inputType: "number" },
    ];
    const reportFilterState = new Map();
    let reportFilterTimer = null;
    let latestReports = [];
    let facilitiesCache = [];
    const reportDateScopePanel = document.getElementById("reportDateScope");
    const reportDateStartRange = document.getElementById("reportDateStartRange");
    const reportDateEndRange = document.getElementById("reportDateEndRange");
    const reportDateStartInput = document.getElementById("reportDateStartInput");
    const reportDateEndInput = document.getElementById("reportDateEndInput");
    let reportDateTicks = [];
    let selectedReportStartTime = null;
    let selectedReportEndTime = null;
    let isReportTimelineExpanded = false;

    function setReportTimelineExpanded(expanded) {
      isReportTimelineExpanded = expanded;
      if (reportDateScopePanel) {
        reportDateScopePanel.classList.toggle("expanded", expanded);
        reportDateScopePanel.setAttribute("aria-hidden", expanded ? "false" : "true");
      }
    }

    function updateTimelineFilterAvailability(hasData) {
      if (!reportFilterSelector) return;
      const option =
        reportFilterSelector.querySelector(`[value="${TIMELINE_FILTER_KEY}"]`);
      if (!option) return;
      option.disabled = !hasData;
      if (!hasData && isReportTimelineExpanded) {
        setReportTimelineExpanded(false);
      }
    }

    setReportTimelineExpanded(false);

    function buildReportFilterParams() {
      const params = {};
      reportFilterState.forEach((entry, key) => {
        const datasetValue = entry.input?.dataset?.filterValue;
        const candidate =
          typeof datasetValue === "string" && datasetValue.trim().length
            ? datasetValue.trim()
            : (entry.input?.value ?? "").toString().trim();
        if (candidate.length) {
          params[key] = candidate;
        }
      });
      return params;
    }

    function buildReportQueryString(params) {
      const entries = Object.entries(params);
      if (!entries.length) return "";
      return `?${entries
        .map(
          ([key, value]) =>
            `${encodeURIComponent(key)}=${encodeURIComponent(value)}`
        )
        .join("&")}`;
    }

    function hasActiveFilterInputValues() {
      for (const entry of reportFilterState.values()) {
        const datasetValue = entry.input?.dataset?.filterValue;
        const candidate =
          typeof datasetValue === "string" && datasetValue.trim().length
            ? datasetValue.trim()
            : (entry.input?.value ?? "").toString().trim();
        if (candidate.length) {
          return true;
        }
      }
      return false;
    }

    function toggleClearFiltersVisibility() {
      if (!clearReportFiltersBtn) return;
      const shouldShow = hasActiveFilterInputValues();
      clearReportFiltersBtn.classList.toggle("d-none", !shouldShow);
    }

    function formatTimestampForInput(timestamp) {
      if (timestamp == null) return "";
      const candidate = new Date(timestamp);
      if (Number.isNaN(candidate.getTime())) return "";
      const tzOffset = candidate.getTimezoneOffset();
      const localDate = new Date(candidate.getTime() - tzOffset * 60000);
      return localDate.toISOString().slice(0, 16);
    }

    function findClosestReportDateIndex(value) {
      if (!reportDateTicks.length) return 0;
      const timestamp = value ? new Date(value).getTime() : NaN;
      if (Number.isNaN(timestamp)) return 0;
      let closest = 0;
      let minDiff = Infinity;
      reportDateTicks.forEach((ts, idx) => {
        const diff = Math.abs(ts - timestamp);
        if (diff < minDiff) {
          minDiff = diff;
          closest = idx;
        }
      });
      return closest;
    }

    function applyReportDateFilter(reports = []) {
      if (!selectedReportStartTime || !selectedReportEndTime) {
        return reports;
      }
      return reports.filter((report) => {
        const createdAt = report?.created_at;
        if (!createdAt) return false;
        const ts = new Date(createdAt).getTime();
        if (Number.isNaN(ts)) return false;
        return ts >= selectedReportStartTime && ts <= selectedReportEndTime;
      });
    }

    function renderReportsList(reports = latestReports) {
      const baseReports = Array.isArray(reports) ? reports : [];
      const filteredReports = applyReportDateFilter(baseReports);
      if (!filteredReports.length) {
        const message =
          baseReports.length > 0
            ? "No reports match the selected date range."
            : "No reports submitted yet.";
        if (reportsContainer) {
          reportsContainer.innerHTML = `<p class='text-muted'>${message}</p>`;
        }
        return;
      }
      if (reportsContainer) {
        reportsContainer.innerHTML = filteredReports
          .map((r) => {
            const when = r.created_at ? new Date(r.created_at).toLocaleString() : "";
            const makeLabel = escapeHtml(r.make ?? "");
            const modelLabel = escapeHtml(r.model ?? "");
            const yearLabel = r.year ? `(${escapeHtml(r.year)})` : "";
            const vinLabel = escapeHtml(r.vin ?? "‚Äî");
            const whenLabel = when ? escapeHtml(when) : "‚Äî";
            const headingParts = [makeLabel, modelLabel].filter(Boolean);
            if (yearLabel) headingParts.push(yearLabel);
            const vehicleHeading =
              headingParts.length > 0 ? headingParts.join(" ") : "Damage Report";
            const vehicleHeadingLabel =
              headingParts.length > 0 ? vehicleHeading : escapeHtml(vehicleHeading);
            const reportIdValue = r.report_id || r.id || "";
            const reportIdLabel = escapeHtml(reportIdValue || "N/A");
            const damageTableHtml = renderDamageEntriesTable(r);
            const photos = collectReportPhotoUrls(r);
            const displayedPhotos = photos.slice(0, 8);
            const extraPhotos = Math.max(photos.length - displayedPhotos.length, 0);
            let splats = normalizeMediaList(r.splat_urls);
            if (!splats.length) splats = normalizeMediaList(r.splat_urls_original);
            const displayedSplats = splats.slice(0, 4);
            const extraSplats = Math.max(splats.length - displayedSplats.length, 0);
            const pdfCandidates = normalizeMediaList(r.pdf_url);
            const pdfFallbacks = normalizeMediaList(r.pdf_url_original);
            const pdfUrl = (pdfCandidates[0] || pdfFallbacks[0] || "").trim();
            const pdfAction = pdfUrl
              ? `<a class="btn btn-sm btn-success" href="${escapeHtml(
                  pdfUrl
                )}" target="_blank" rel="noopener">Download PDF</a>`
              : `<span class="badge bg-light text-muted border">PDF not generated</span>`;
            const commentText =
              r.comments && typeof r.comments === "string"
                ? escapeHtml(r.comments)
                : "";
            const photosHtml = renderMediaGrid(displayedPhotos, {
              emptyMessage: "No photos uploaded.",
            });
            const extraPhotosNote =
              extraPhotos > 0
                ? `<div class="small text-muted mt-1">+${extraPhotos} more photo${
                    extraPhotos === 1 ? "" : "s"
                  } in storage</div>`
                : "";
            const splatsHtml = renderMediaGrid(displayedSplats, {
              emptyMessage: "Splat chart not captured.",
              imageClass: "report-media-img--splat",
            });
            const extraSplatsNote =
              extraSplats > 0
                ? `<div class="small text-muted mt-1">+${extraSplats} additional splat${
                    extraSplats === 1 ? "" : "s"
                  } available</div>`
                : "";
            const locationInfoHtml = renderReportLocationInfo(r);
            const commentHtml = commentText
              ? `<p class="report-card-comment small text-muted"><strong>Comments:</strong> ${commentText}</p>`
              : "";
            return `
              <div class="report-card fade-in">
                <div class="report-card-top-row">
                  <div class="report-card-meta">
                    <h6 class="mb-1">${vehicleHeadingLabel}</h6>
                    <div class="small text-muted">VIN: ${vinLabel}</div>
                    <div class="small text-muted mb-1">${whenLabel}</div>
                    <div class="small text-muted">Report ID: ${reportIdLabel}</div>
                  </div>
                  <div class="report-card-table-col">
                    ${damageTableHtml}
                </div>
              </div>
              ${locationInfoHtml}
              ${commentHtml}
                <div class="report-card-body">
                  <div class="report-card-body__content">
                    <div class="report-actions mt-2">
                      ${pdfAction}
                    </div>
                    <div class="mt-3">
                      <h6 class="text-uppercase text-muted small mb-1">Inspection Photos</h6>
                      ${photosHtml}
                      ${extraPhotosNote}
                    </div>
                    <div class="mt-3">
                      <h6 class="text-uppercase text-muted small mb-1">Splat Visuals</h6>
                      ${splatsHtml}
                      ${extraSplatsNote}
                    </div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }
    }

    function updateSelectedDateRangeFromRanges(startIdx, endIdx) {
      if (!reportDateTicks.length) {
        selectedReportStartTime = null;
        selectedReportEndTime = null;
        renderReportsList();
        return;
      }
      const boundedStart = Math.max(0, Math.min(startIdx, endIdx));
      const boundedEnd = Math.min(
        reportDateTicks.length - 1,
        Math.max(startIdx, endIdx)
      );
      if (reportDateStartRange) {
        reportDateStartRange.value = boundedStart;
      }
      if (reportDateEndRange) {
        reportDateEndRange.value = boundedEnd;
      }
      selectedReportStartTime = reportDateTicks[boundedStart];
      selectedReportEndTime = reportDateTicks[boundedEnd];
      if (reportDateStartInput) {
        reportDateStartInput.value = formatTimestampForInput(
          selectedReportStartTime
        );
      }
      if (reportDateEndInput) {
        reportDateEndInput.value = formatTimestampForInput(selectedReportEndTime);
      }
      renderReportsList(latestReports);
    }

    function updateReportDateScopeControls(reports = []) {
      const timestamps = Array.from(
        new Set(
          reports
            .map((r) => r.created_at)
            .filter(Boolean)
            .map((value) => new Date(value).getTime())
            .filter((time) => !Number.isNaN(time))
        )
      ).sort((a, b) => a - b);
      reportDateTicks = timestamps;
      if (!timestamps.length) {
        selectedReportStartTime = null;
        selectedReportEndTime = null;
        renderReportsList(reports);
        updateTimelineFilterAvailability(false);
        return;
      }
      updateTimelineFilterAvailability(true);
      const lastIndex = timestamps.length - 1;
      if (reportDateStartRange) {
        reportDateStartRange.min = 0;
        reportDateStartRange.max = lastIndex;
      }
      if (reportDateEndRange) {
        reportDateEndRange.min = 0;
        reportDateEndRange.max = lastIndex;
      }
      updateSelectedDateRangeFromRanges(0, lastIndex);
      setReportTimelineExpanded(false);
    }

    if (reportDateStartRange) {
      reportDateStartRange.addEventListener("input", () => {
        updateSelectedDateRangeFromRanges(
          Number(reportDateStartRange.value),
          Number(
            reportDateEndRange ? reportDateEndRange.value : reportDateTicks.length - 1
          )
        );
      });
    }
    if (reportDateEndRange) {
      reportDateEndRange.addEventListener("input", () => {
        updateSelectedDateRangeFromRanges(
          Number(reportDateStartRange ? reportDateStartRange.value : 0),
          Number(reportDateEndRange.value)
        );
      });
    }
    if (reportDateStartInput) {
      reportDateStartInput.addEventListener("change", () => {
        const targetIndex = findClosestReportDateIndex(reportDateStartInput.value);
        updateSelectedDateRangeFromRanges(
          targetIndex,
          Number(reportDateEndRange ? reportDateEndRange.value : reportDateTicks.length - 1)
        );
      });
    }
    if (reportDateEndInput) {
      reportDateEndInput.addEventListener("change", () => {
        const targetIndex = findClosestReportDateIndex(reportDateEndInput.value);
        updateSelectedDateRangeFromRanges(
          Number(reportDateStartRange ? reportDateStartRange.value : 0),
          targetIndex
        );
      });
    }

    function createReportFilterChip(config) {
      if (!activeReportFilters) return null;
      const chip = document.createElement("div");
      chip.className = "report-filter-chip";
      chip.dataset.filterKey = config.key;
      const label = document.createElement("span");
      label.className = "report-filter-chip__label";
      label.textContent = config.label;
      const input = document.createElement("input");
      input.type = config.inputType || "text";
      input.className = "report-filter-chip__input";
      input.placeholder = config.placeholder || `Enter ${config.label}`;
      input.autocomplete = "off";
      if (config.readOnly) {
        input.readOnly = true;
        input.style.cursor = "not-allowed";
      }
      input.addEventListener("input", () => {
        toggleClearFiltersVisibility();
        scheduleReportRefresh();
      });
      input.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          scheduleReportRefresh(true);
        }
      });
      const closeBtn = document.createElement("button");
      closeBtn.type = "button";
      closeBtn.className = "btn-close";
      closeBtn.setAttribute("aria-label", `Remove ${config.label} filter`);
      closeBtn.addEventListener("click", () => {
        removeReportFilter(config.key);
        scheduleReportRefresh(true);
      });
      chip.append(label, input, closeBtn);
      activeReportFilters.appendChild(chip);
      reportFilterState.set(config.key, { config, chip, input });
      toggleClearFiltersVisibility();
      return reportFilterState.get(config.key);
    }

    function ensureReportFilterEntry(config) {
      return reportFilterState.get(config.key) || createReportFilterChip(config);
    }

    function removeReportFilter(key) {
      const entry = reportFilterState.get(key);
      if (!entry) return;
      entry.chip.remove();
      reportFilterState.delete(key);
      if (key === "user_uuid" && adminUserFilterSelect) {
        adminUserFilterSelect.value = "";
      }
      toggleClearFiltersVisibility();
    }

    function clearReportFilters() {
      reportFilterState.forEach((entry) => {
        entry.chip.remove();
      });
      reportFilterState.clear();
      if (adminUserFilterSelect) {
        adminUserFilterSelect.value = "";
      }
      toggleClearFiltersVisibility();
      setReportTimelineExpanded(false);
    }

    function scheduleReportRefresh(immediate = false) {
      if (reportFilterTimer) {
        clearTimeout(reportFilterTimer);
        reportFilterTimer = null;
      }
      if (immediate) {
        fetchReports();
        return;
      }
      reportFilterTimer = setTimeout(() => {
        reportFilterTimer = null;
        fetchReports();
      }, 300);
    }

    function renderReportFilterOptions() {
      if (!reportFilterSelector) return;
      const options = REPORT_FILTER_OPTIONS.filter(
        (option) => !option.adminOnly || isAdminUser
      );
      const markup = [
        `<option value="">Choose a filter‚Ä¶</option>`,
        ...options.map(
          (option) =>
            `<option value="${escapeHtml(option.key)}">${escapeHtml(
              option.label
            )}</option>`
        ),
      ].join("");
      reportFilterSelector.innerHTML = markup;
      updateTimelineFilterAvailability(Boolean(reportDateTicks.length));
    }

    function updateAdminUserDropdown(reports) {
      if (!adminUserFilterRow || !adminUserFilterSelect) {
        return;
      }
      const showRow = isAdminUser;
      adminUserFilterRow.classList.toggle("d-none", !showRow);
      if (!showRow) {
        return;
      }
      const users = new Map();
      Array.isArray(reports) &&
        reports.forEach((report) => {
          const uuid = report?.user_uuid;
          if (!uuid) return;
          const label =
            (report?.inspector_email && report.inspector_email.trim()) ||
            uuid;
          if (!users.has(uuid)) {
            users.set(uuid, label);
          }
        });
      const options = [`<option value="">All users</option>`];
      if (!users.size) {
        options.push(
          `<option value="" disabled>No user reports captured yet</option>`
        );
        adminUserFilterSelect.disabled = true;
      } else {
        adminUserFilterSelect.disabled = false;
        Array.from(users.entries())
          .sort(([, aLabel], [, bLabel]) => aLabel.localeCompare(bLabel))
          .forEach(([uuid, label]) => {
            options.push(
              `<option value="${escapeHtml(uuid)}">${escapeHtml(label)}</option>`
            );
          });
      }
      const userEntry = reportFilterState.get("user_uuid");
      const activeUuid =
        userEntry?.input?.dataset?.filterValue ||
        (userEntry?.input?.value ?? "").toString().trim();
      adminUserFilterSelect.innerHTML = options.join("");
      if (activeUuid && users.has(activeUuid)) {
        adminUserFilterSelect.value = activeUuid;
      } else {
        adminUserFilterSelect.value = "";
        if (userEntry) {
          userEntry.input.value = "";
          delete userEntry.input.dataset.filterValue;
          removeReportFilter("user_uuid");
        }
      }
    }

    function persistPortalToken(token) {
      try {
        const storage = window.localStorage;
        if (token && token.trim()) {
          storage.setItem("portal_token", token);
          storage.setItem("portal_authenticated", "true");
        } else {
          storage.removeItem("portal_token");
          storage.removeItem("portal_authenticated");
        }
      } catch (err) {
        console.warn("Portal token persistence failed", err);
      }
    }

    function persistPortalUser(user) {
      if (!user) return;
      try {
        const storage = window.localStorage;
        storage.setItem("portal_user", JSON.stringify(user));
        storage.setItem("portal_authenticated", "true");
      } catch (err) {
        console.warn("Portal user persistence failed", err);
      }
    }

    function clearPortalAuthStorage() {
      hidePortalPromoOfferPanel();
      try {
        const storage = window.localStorage;
        storage.removeItem("portal_token");
        storage.removeItem("portal_user");
        storage.removeItem("portal_authenticated");
      } catch (err) {
        console.warn("Clearing portal storage failed", err);
      }
    }

    function updateSidebarCollapsed(collapsed, options = {}) {
      if (!portal) return;
      portal.classList.toggle("sidebar-collapsed", collapsed);
      if (sidebarToggle) {
        sidebarToggle.setAttribute("aria-expanded", collapsed ? "false" : "true");
      }
      if (options.persist) {
        try {
          window.localStorage.setItem(sidebarCollapseStorageKey, collapsed ? "1" : "0");
        } catch (err) {
          console.warn("Unable to persist sidebar state", err);
        }
      }
    }

    function restoreSidebarCollapsedState() {
      if (!portal) return;
      updateSidebarCollapsed(false);
      try {
        window.localStorage.removeItem(sidebarCollapseStorageKey);
      } catch (err) {
        console.warn("Unable to clear sidebar state", err);
      }
    }

    const deleteBtn = document.getElementById("deleteAccountBtn");
    const tosLink = document.getElementById("tosLink");
    const splatGenerator = new SplatChartGenerator();
    let splatPreviewPending = false;
    let currentSplatPreview = null;
    let splatPreviewPromise = Promise.resolve(null);
    let lastSplatWarningKey = "";

    function updateAdminVisibility() {
      const showAdminUi = isAdminUser;
      const showBrandingUi = isOrgAdminUser;
      const showFacilitiesUi = isOrgAdminUser;
      brandingNavLink?.classList.toggle("d-none", !showBrandingUi);
      brandingSection?.classList.toggle("d-none", !showBrandingUi);
      facilitiesNavLink?.classList.toggle("d-none", !showFacilitiesUi);
      facilitiesSection?.classList.toggle("d-none", !showFacilitiesUi);
      adminUserFilterRow?.classList.toggle("d-none", !showAdminUi);
      renderReportFilterOptions();
      if (!showBrandingUi && brandingSection?.classList.contains("active")) {
        const fallbackLink = document.querySelector('[data-page="dashboard"]');
        fallbackLink?.click();
      }
      if (!showFacilitiesUi && facilitiesSection?.classList.contains("active")) {
        const fallbackLink = document.querySelector('[data-page="dashboard"]');
        fallbackLink?.click();
      }
    }

    function resetFacilityForm() {
      facilityForm?.reset();
      if (facilityIdInput) {
        facilityIdInput.value = "";
      }
      if (facilitySlugInput) {
        facilitySlugInput.value = "";
      }
      if (facilityActiveSelect) {
        facilityActiveSelect.value = "true";
      }
      if (facilityFormStatus) {
        facilityFormStatus.textContent = "";
      }
    }

    function prefillFacilityForm(location) {
      if (!location) {
        resetFacilityForm();
        return;
      }
      facilityIdInput.value = location.location_id || "";
      if (facilitySlugInput) {
        facilitySlugInput.value = location.location_id || "";
      }
      facilityNameInput.value = location.location_name || "";
      facilityLabelInput.value = location.location_label || "";
      facilityNotesInput.value =
        (location.metadata?.notes || "").toString();
      facilityActiveSelect.value = location.is_active ? "true" : "false";
      if (facilityFormStatus) {
        facilityFormStatus.textContent = "Editing facility ‚Äî save to persist changes.";
      }
    }

    function renderFacilitiesList(locations = []) {
      if (!facilitiesList) return;
      if (!locations.length) {
        facilitiesList.innerHTML =
          '<p class="text-muted small mb-0">No facilities have been added yet.</p>';
        return;
      }
      const rowsHtml = locations
        .map((location) => {
          const notes = (location.metadata?.notes || "").toString().trim();
          const label = location.location_label?.trim() || "";
          return `
            <tr>
              <td><strong>${escapeHtml(location.location_name)}</strong></td>
              <td>
                ${label
                  ? escapeHtml(label)
                  : '<span class="text-muted small">No label</span>'}
              </td>
              <td>
                ${notes
                  ? escapeHtml(notes)
                  : '<span class="text-muted small">No notes</span>'}
              </td>
              <td>
                ${location.is_active
                  ? '<span class="badge bg-success">Active</span>'
                  : '<span class="badge bg-secondary">Inactive</span>'}
              </td>
              <td class="text-end">
                <button
                        type="button"
                        class="btn btn-sm btn-outline-primary edit-facility-btn"
                        data-location-id="${escapeHtml(location.location_id)}"
                >
                  Edit
                </button>
              </td>
            </tr>
          `;
        })
        .join("");
      facilitiesList.innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm table-borderless align-middle mb-0">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Label</th>
                <th scope="col">Notes</th>
                <th scope="col">Status</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        </div>
      `;
    }

    async function loadFacilities() {
      if (!isOrgAdminUser || !organizationIdForBranding) {
        return;
      }
      if (facilitiesStatus) {
        facilitiesStatus.textContent = "Loading facilities‚Ä¶";
      }
      try {
        const response = await apiFetch(
          `${apiBase}/organizations/${organizationIdForBranding}/locations`,
        );
        const payload = await response.json().catch(() => null);
        if (!response.ok) {
          throw new Error(payload?.error || `Unable to load facilities (${response.status}).`);
        }
        facilitiesCache = Array.isArray(payload?.locations)
          ? payload.locations
          : [];
        renderFacilitiesList(facilitiesCache);
        resetFacilityForm();
        if (facilitiesStatus) {
          facilitiesStatus.textContent = "";
        }
      } catch (error) {
        if (facilitiesStatus) {
          facilitiesStatus.textContent =
            error.message || "Unable to load facilities.";
        }
        console.error("Facilities load error:", error);
      }
    }

    async function handleFacilityFormSubmit(event) {
      if (!facilityForm) return;
      event.preventDefault();
      if (!isOrgAdminUser || !organizationIdForBranding) {
        facilityFormStatus?.classList.remove("text-success");
        facilityFormStatus?.classList.add("text-danger");
        if (facilityFormStatus) {
          facilityFormStatus.textContent = "You are not authorized to manage facilities.";
        }
        return;
      }
      if (!facilityForm.checkValidity()) {
        facilityForm.reportValidity();
        return;
      }
      const nameValue = facilityNameInput?.value?.trim() || "";
      if (!nameValue) {
        facilityFormStatus?.classList.add("text-danger");
        facilityFormStatus?.classList.remove("text-success");
        if (facilityFormStatus) {
          facilityFormStatus.textContent = "Facility name is required.";
        }
        return;
      }
      const payload = {
        location_name: nameValue,
        location_label: facilityLabelInput?.value?.trim() || "",
        metadata: {
          notes: facilityNotesInput?.value?.trim() || "",
        },
        is_active: (facilityActiveSelect?.value || "true") === "true",
      };
      const editingId = (facilityIdInput?.value || "").trim();
      const existingSlug = facilitySlugInput?.value?.trim() || "";
      let locationSlug = existingSlug;
      if (!locationSlug && !editingId) {
        locationSlug = buildFacilityLocationId(
          facilityNameInput?.value,
          facilityLabelInput?.value,
        );
        if (facilitySlugInput) {
          facilitySlugInput.value = locationSlug;
        }
      }
      if (locationSlug) {
        payload.location_id = locationSlug;
      }
      const endpointBase = `${apiBase}/organizations/${organizationIdForBranding}/locations`;
      const method = editingId ? "PUT" : "POST";
      const endpoint = editingId
        ? `${endpointBase}/${encodeURIComponent(editingId)}`
        : endpointBase;
      try {
        facilityFormStatus?.classList.remove("text-danger");
        facilityFormStatus?.classList.add("text-muted");
        if (facilityFormStatus) {
          facilityFormStatus.textContent = "Saving facility‚Ä¶";
        }
        const response = await apiFetch(endpoint, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const body = await response.json().catch(() => null);
        if (!response.ok) {
          throw new Error(body?.error || "Unable to save facility.");
        }
        facilityFormStatus?.classList.remove("text-muted");
        facilityFormStatus?.classList.add("text-success");
        if (facilityFormStatus) {
          facilityFormStatus.textContent = "Facility saved.";
        }
        await loadFacilities();
      } catch (error) {
        facilityFormStatus?.classList.remove("text-success");
        facilityFormStatus?.classList.add("text-danger");
        if (facilityFormStatus) {
          facilityFormStatus.textContent = error.message || "Failed to save facility.";
        }
        console.error("Facility submit error:", error);
      }
    }
    updateAdminVisibility();

    const BRANDING_COLOR_DEFAULTS = {
      primary_color: "#0c95d2",
      secondary_color: "#0d6efd",
      accent_color: "#80b7ff",
      button_color: "#0d6efd",
      background_color: "#f4f6fa",
      text_color: "#111827",
      border_color: "#d7e3ff",
      error_color: "#ef4444",
      success_color: "#22c55e",
      warning_color: "#f97316",
    };
    const DEFAULT_CUSTOM_THEME = {
      previewPadding: 18,
      buttonRadius: 10,
    };
    let currentCustomTheme = { ...DEFAULT_CUSTOM_THEME };
    let currentColorSwatch = {};
    let currentEmailTemplates = {};

    function safeParseJson(value, fallback = {}) {
      if (typeof value === "object" && value !== null) {
        return value;
      }
      if (!value) {
        return { ...fallback };
      }
      try {
        return JSON.parse(value);
      } catch (err) {
        console.warn("Failed to parse branding JSON:", err);
        return { ...fallback };
      }
    }

    function formatTimestamp(value) {
      if (!value) return "‚Äî";
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) {
        return "‚Äî";
      }
      return parsed.toLocaleString();
    }

    function refreshBrandingPreviewTheme() {
      if (!brandingPreviewDemo) return;
      const palette = {};
      brandingColorInputs?.forEach((input) => {
        const field = input.dataset.field;
        if (!field) return;
        palette[field] = input.value || BRANDING_COLOR_DEFAULTS[field] || "#ffffff";
      });
      const background = palette.background_color || BRANDING_COLOR_DEFAULTS.background_color;
      const textColor = palette.text_color || BRANDING_COLOR_DEFAULTS.text_color;
      const borderColor = palette.border_color || BRANDING_COLOR_DEFAULTS.border_color;
      const buttonColor =
        palette.button_color ||
        palette.accent_color ||
        BRANDING_COLOR_DEFAULTS.button_color;
      brandingPreviewDemo.style.background = background;
      brandingPreviewDemo.style.color = textColor;
      brandingPreviewDemo.style.borderColor = borderColor;
      if (brandingDemoText) {
        brandingDemoText.style.color = textColor;
      }
      if (brandingDemoButton) {
        brandingDemoButton.style.background = buttonColor;
        brandingDemoButton.style.color = "#fff";
      }
    }

    function setCustomThemeValues(theme = {}) {
      currentCustomTheme = {
        ...DEFAULT_CUSTOM_THEME,
        ...currentCustomTheme,
        ...theme,
      };
      const spacing = Number(currentCustomTheme.previewPadding);
      const radius = Number(currentCustomTheme.buttonRadius);
      if (brandingPreviewSpacing) {
        brandingPreviewSpacing.value = spacing;
      }
      if (brandingPreviewSpacingValue) {
        brandingPreviewSpacingValue.textContent = `${spacing}px`;
      }
      if (brandingPreviewDemo) {
        brandingPreviewDemo.style.padding = `${spacing}px`;
      }
      if (brandingButtonRadius) {
        brandingButtonRadius.value = radius;
      }
      if (brandingButtonRadiusValue) {
        brandingButtonRadiusValue.textContent = `${radius}px`;
      }
      if (brandingDemoButton) {
        brandingDemoButton.style.borderRadius = `${radius}px`;
      }
      if (brandingCustomThemeDataInput) {
        brandingCustomThemeDataInput.value = JSON.stringify(currentCustomTheme);
      }
      refreshBrandingPreviewTheme();
    }

    function buildColorSwatchObject() {
      return { ...currentColorSwatch };
    }

    function updateBrandingMetadata(data = {}) {
      if (brandingOrganizationInfo) {
        const info = [];
        if (data.organization_id) {
          info.push(`Org ID: ${data.organization_id}`);
        }
        brandingOrganizationInfo.textContent = info.join(" ¬∑ ");
      }
      if (brandingUpdatedAt) {
        brandingUpdatedAt.textContent = formatTimestamp(data.updated_at);
      }
    }

    async function loadBrandingPanel(force = false) {
      if (!isOrgAdminUser || !organizationIdForBranding) {
        return;
      }
      if (brandingPanelLoaded && !force) {
        return;
      }
      if (brandingPanelLoading) {
        return;
      }
      brandingPanelLoading = true;
      brandingSaveStatus.textContent = "Loading branding‚Ä¶";
      try {
        const response = await apiFetch(
          `${apiBase}/organizations/${organizationIdForBranding}/branding`
        );
        if (!response.ok) {
          const body = await response.json().catch(() => null);
          throw new Error(
            body?.error || `Failed to load branding (${response.status})`
          );
        }
        const payload = await response.json().catch(() => null) || {};
        setBrandingFormValues(payload);
        brandingPanelLoaded = true;
      } catch (error) {
        notify("danger", error.message || "Unable to load branding settings.");
      } finally {
        brandingPanelLoading = false;
        brandingSaveStatus.textContent = "";
      }
    }

    function setBrandingFormValues(data = {}) {
      const brandingValues = data.branding || {};
      const fallbackName =
        data.organization_name ||
        brandingValues.organization_name ||
        data.brand_name ||
        brandingValues.brand_name ||
        currentUserProfile?.organization?.name ||
        "";
      if (brandingNameInput) {
        brandingNameInput.value = fallbackName;
      }
      Array.from(brandingFields || []).forEach((field) => {
        const fieldName = field.dataset.field;
        if (!fieldName) return;
        const sourceValue =
          data[fieldName] ??
          brandingValues[fieldName];
        let value = sourceValue;
        if (fieldName === "organization_name" && !value) {
          value = fallbackName;
        }
        if (value === undefined) return;
        if (field.type === "checkbox") {
          field.checked = Boolean(value);
        } else if (field.dataset.parse === "json") {
          const fallbackJson =
            fieldName === "custom_theme_data" ? DEFAULT_CUSTOM_THEME : {};
          const parsed = safeParseJson(value, fallbackJson);
          field.value = JSON.stringify(parsed);
        } else {
          field.value = value;
        }
      });
      Array.from(brandingColorInputs || []).forEach((input) => {
        const fieldName = input.dataset.field;
        if (!fieldName) return;
        const fallbackColor =
          BRANDING_COLOR_DEFAULTS[fieldName] ?? "#ffffff";
        const value =
          data[fieldName] ?? brandingValues[fieldName] ?? fallbackColor;
        input.value = value;
      });
      const emailTemplatesValue =
        data.email_templates ??
        brandingValues.email_templates ??
        {};
      currentEmailTemplates = safeParseJson(emailTemplatesValue, {});
      if (brandingEmailTemplatesInput) {
        brandingEmailTemplatesInput.value = JSON.stringify(currentEmailTemplates);
      }
      currentLogoUrl = data.logo_url || data.logo || "";
      if (brandingLogoPreview) {
        if (currentLogoUrl) {
          brandingLogoPreview.src = currentLogoUrl;
          brandingLogoPreview.hidden = false;
        } else {
          brandingLogoPreview.removeAttribute("src");
          brandingLogoPreview.hidden = true;
        }
      }
      if (brandingLogoStatus) {
        brandingLogoStatus.textContent =
          "Upload a transparent PNG or SVG that will appear in reports and emails.";
      }
      const metadataSource = { ...data, ...brandingValues };
      updateBrandingMetadata(metadataSource);
      currentCustomTheme = { ...DEFAULT_CUSTOM_THEME };
      const themePayload =
        data.custom_theme_data ??
        brandingValues.custom_theme_data ??
        {};
      setCustomThemeValues(safeParseJson(themePayload, {}));
      updateBrandingPreviewSwatch();
    }

    function updateBrandingPreviewSwatch() {
      if (!brandingPreviewSwatch) return;
      const swatchItems = [];
      const swatchData = {};
      Array.from(brandingColorInputs || []).forEach((input) => {
        const field = input.dataset.field;
        if (!field) return;
        const value =
          input.value ||
          BRANDING_COLOR_DEFAULTS[field] ||
          "#ffffff";
        const label =
          input.dataset.label ||
          field.replace(/_/g, " ").replace(/\b\w/g, (char) =>
            char.toUpperCase()
          );
        swatchData[field] = value;
        swatchItems.push(
          `<div class="branding-swatch"><span class="branding-swatch-dot" style="background:${value};"></span><span>${label}: ${value}</span></div>`
        );
      });
      currentColorSwatch = swatchData;
      brandingPreviewSwatch.innerHTML = swatchItems.join("");
      refreshBrandingPreviewTheme();
    }

    async function uploadBrandingLogo(file) {
      if (!file || !organizationIdForBranding) {
        throw new Error("Unable to upload logo: missing organization.");
      }
      const formData = new FormData();
      formData.append("file", file, file.name);
      formData.append("report_id", `branding-${organizationIdForBranding}`);
      const response = await apiFetch(`${apiBase}/photos/upload`, {
        method: "POST",
        body: formData,
      });
      if (!response.ok) {
        const body = await response.json().catch(() => null);
        throw new Error(body?.error || `Upload failed (${response.status})`);
      }
      const body = await response.json().catch(() => null);
      const url =
        Array.isArray(body?.urls) && body.urls.length
          ? body.urls[0]
          : null;
      if (!url) {
        throw new Error("Upload completed but no URL returned.");
      }
      currentLogoUrl = url;
      if (brandingLogoPreview) {
        brandingLogoPreview.src = url;
        brandingLogoPreview.hidden = false;
      }
      if (brandingLogoStatus) {
        brandingLogoStatus.textContent = "Logo uploaded";
      }
      return url;
    }

    async function handleBrandingFormSubmit(event) {
      event.preventDefault();
      if (!isOrgAdminUser || !organizationIdForBranding) {
        notify(
          "danger",
          "Organization admins can only update branding."
        );
        return;
      }
      const payload = {};
      Array.from(brandingFields || []).forEach((field) => {
        const fieldName = field.dataset.field;
        if (!fieldName) return;
        let value;
        if (field.type === "checkbox") {
          value = field.checked;
        } else if (field.dataset.parse === "json") {
          const jsonFallback =
            fieldName === "custom_theme_data"
              ? currentCustomTheme
              : fieldName === "email_templates"
              ? currentEmailTemplates
              : {};
          value = safeParseJson(field.value, jsonFallback);
        } else {
          value = field.value;
        }
        payload[fieldName] = value;
      });
      Array.from(brandingColorInputs || []).forEach((input) => {
        const field = input.dataset.field;
        if (field) {
          payload[field] = input.value;
        }
      });
      payload.color_swatch = buildColorSwatchObject();
      if (brandingNameInput) {
        payload.organization_name = brandingNameInput.value?.trim();
      }
      if (currentLogoUrl) {
        payload.logo_url = currentLogoUrl;
      }
      brandingSaveBtn?.setAttribute("disabled", "true");
      brandingSaveStatus.textContent = "Saving branding‚Ä¶";
      try {
        const response = await apiFetch(
          `${apiBase}/organizations/${organizationIdForBranding}/branding`,
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          },
        );
        if (!response.ok) {
          const body = await response.json().catch(() => null);
          throw new Error(
            body?.error || `Failed to save branding (${response.status})`,
          );
        }
        notify(
          "success",
          "Branding saved. The new palette will be reflected in the next emails.",
        );
        brandingPanelLoaded = false;
        await loadBrandingPanel(true);
      } catch (error) {
        notify("danger", error.message || "Unable to save branding.");
      } finally {
        brandingSaveBtn?.removeAttribute("disabled");
        brandingSaveStatus.textContent = "";
      }
    }

    function padBase64(str) {
      return str + "=".repeat((4 - (str.length % 4)) % 4);
    }

    function decodeJwt(token) {
      try {
        const parts = token.split(".");
        if (parts.length < 2) return null;
        const normalized = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        const decoded = atob(padBase64(normalized));
        return JSON.parse(decoded);
      } catch (err) {
        console.warn("Failed to decode JWT", err);
        return null;
      }
    }

    function clearTokenTimer() {
      if (tokenExpiryTimer) {
        clearTimeout(tokenExpiryTimer);
        tokenExpiryTimer = null;
      }
    }

    function scheduleTokenRefresh(token) {
      clearTokenTimer();
      const payload = decodeJwt(token);
      if (!payload?.exp) return;
      const msUntilExpiry = payload.exp * 1000 - Date.now();
      if (msUntilExpiry <= 120000) {
        ensureAccessToken(true).catch((err) => {
          console.error("Token refresh failed", err);
        });
        return;
      }
      tokenExpiryTimer = setTimeout(() => {
        ensureAccessToken(true).catch((err) => {
          console.error("Token refresh failed", err);
        });
      }, msUntilExpiry - 60000);
    }

    async function ensureAccessToken(force = false) {
      if (force) accessToken = null;
      if (accessToken) return accessToken;
      const storedPortalToken = window.localStorage.getItem("portal_token");
      if (storedPortalToken && storedPortalToken !== "") {
        persistPortalToken(storedPortalToken);
        accessToken = storedPortalToken;
        scheduleTokenRefresh(accessToken);
        return accessToken;
      }
      if (!auth0Client) throw new Error("Auth0 client not initialized");
      try {
        const token = await auth0Client.getTokenSilently();
        accessToken = token;
        persistPortalToken(token);
        scheduleTokenRefresh(token);
        return token;
      } catch (err) {
        clearPortalAuthStorage();
        console.error("Unable to obtain access token", err);
        notify("warning", "Unable to obtain access token. Some features may be unavailable.");
        showLoginScreen("Unable to obtain access token.", err.message || "");
        throw err;
      }
    }

    async function apiFetch(url, options = {}, attempt = 0) {
      const token = await ensureAccessToken(attempt > 0);
      const headers = new Headers(options.headers || {});
      headers.set("Authorization", `Bearer ${token}`);
      if (PORTAL_REQUEST_HEADER) {
        headers.set(PORTAL_REQUEST_HEADER, "1");
      }

      const response = await fetch(url, { ...options, headers });
      if (response.status === 401 && attempt < 1) {
        accessToken = null;
        return apiFetch(url, options, attempt + 1);
      }
      if (response.status === 401) {
        notify("warning", "Unauthorized request. Please refresh your session.");
        showLoginScreen("Unauthorized request.", "You may need to reauthenticate to access this data.");
        throw new Error("Unauthorized");
      }
      return response;
    }

    const sendMailgunEmail = createMailgunClient({ apiBase, apiFetch, notify });

    function showPortalPromoOfferPanel() {
      if (!promoOfferPanel) return;
      promoOfferPanel.classList.remove("d-none");
    }

    function hidePortalPromoOfferPanel() {
      if (!promoOfferPanel) return;
      promoOfferPanel.classList.add("d-none");
    }

    function getPowerBiEmbedUrl() {
      if (isAwctOrganization()) {
        return AWCT_POWERBI_EMBED_URL;
      }
      if (isInterRailOrganization()) {
        return INTER_RAIL_POWERBI_EMBED_URL;
      }
      const candidates = [
        currentUserProfile?.powerbi_embed_url,
        currentUserProfile?.powerBiEmbedUrl,
        currentUserProfile?.powerBiUrl,
        currentUserProfile?.powerbiUrl,
        currentOrganizationProfile?.powerbi_embed_url,
        currentOrganizationProfile?.powerBiEmbedUrl,
      ];
      const match = candidates.find(
        (value) => typeof value === "string" && value.trim()
      );
      return match?.trim?.() || "";
    }

    function renderPowerBiEmbed(embedUrl) {
      const targetUrl = embedUrl?.toString?.().trim();
      if (!powerbiEmbedRatio) return;
      powerbiEmbedRatio.innerHTML = "";
      if (!targetUrl) {
        powerbiEmbedRatio.innerHTML = `
          <div class="text-center text-muted small d-flex align-items-center justify-content-center" style="height:100%;">
            Power BI analytics are restricted for your organization.
          </div>
        `;
        powerbiRestrictedMessage?.classList.remove("d-none");
        return;
      }
      powerbiRestrictedMessage?.classList.add("d-none");
      const iframe = document.createElement("iframe");
      iframe.title = "Docudent Analytics";
      iframe.src = targetUrl;
      iframe.allowFullscreen = true;
      iframe.loading = "lazy";
      iframe.frameBorder = "0";
      iframe.referrerPolicy = "no-referrer";
      iframe.style.width = "100%";
      iframe.style.height = "100%";
      iframe.style.border = "0";
      powerbiEmbedRatio.appendChild(iframe);
    }

    function updatePowerBiSection() {
      renderPowerBiEmbed(getPowerBiEmbedUrl());
    }

    function ensurePortalAccess() {
      return true;
    }

    async function bootstrapUserProfile() {
      try {
        const res = await apiFetch(`${apiBase}/user/me`);
        const payload = await res.json().catch(() => null);
        if (res.status === 403) {
          const message =
            payload?.error || "Your account is not authorized for this portal.";
          notify("danger", message);
          showLoginScreen("Access denied. Contact support for assistance.", message);
          return false;
        }
        if (!res.ok) {
          const message =
            payload?.error || `Unable to load account profile (HTTP ${res.status}).`;
          notify("danger", message);
          showLoginScreen("Unable to load your account. Try again later.", message);
          return false;
        }
        const profile = payload?.user || {};
        currentOrganizationProfile = payload?.organization || null;
        const reportedTier = (payload?.plan_tier || "free-tier").toString();
        currentPlanTier = reportedTier;
        portalAccessGranted = true;
        hidePortalPromoOfferPanel();
        const normalizedRole = (profile?.role || "").toString().trim().toLowerCase();
        currentUserProfile = { ...profile };
        updateAppNavigationVisibility(profile?.app_origin);
        isAdminUser = payload?.is_admin === true || normalizedRole === "admin";
        isOrgAdminUser = normalizedRole === "org_admin";
        const orgTypeRaw =
          payload?.organization_type ||
          payload?.organization?.type ||
          profile?.organization_type;
        isPaidOrganization =
          typeof orgTypeRaw === "string" &&
          orgTypeRaw.trim().toLowerCase() === "paid";
        organizationIdForBranding =
          profile?.organization_id ||
          payload?.organization?.organization_id ||
          "";
        brandingPanelLoaded = false;
        updateAdminVisibility();
        applyOrganizationExperience();
        persistPortalUser(currentUserProfile);
        updatePowerBiSection();
        return true;
      } catch (error) {
        clearPortalAuthStorage();
        const msg = error.message || "Failed to load account profile.";
        notify("danger", msg);
        showLoginScreen("Unable to load your account. Try again later.", msg);
        return false;
      }
    }

    function showLoginScreen(message = "Sign in to continue.", errorMessage = "") {
      hidePortalPromoOfferPanel();
      if (errorBox) {
        errorBox.textContent = errorMessage || message;
      }
    }

    async function submitPortalPromoCode(event) {
      if (event && typeof event.preventDefault === "function") {
        event.preventDefault();
      }
      const promoValue = (portalPromoCodeInput?.value || "").trim();
      if (!promoValue) {
        setPortalPromoStatusText("Enter a promo code to continue.");
        return;
      }
      applyPromoCodeBtn?.setAttribute("disabled", "true");
      setPortalPromoStatusText("Verifying promo code‚Ä¶");
      try {
        const response = await apiFetch(`${apiBase}/portal/promo`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ promoCode: promoValue }),
        });
        const body = await response.json().catch(() => null);
        if (!response.ok) {
          const message =
            body?.error || `Promo code rejected (${response.status}).`;
          throw new Error(message);
        }
        notify(
          "success",
          body?.message || "Promo code accepted. Unlocking portal access‚Ä¶",
        );
        portalPromoModalInstance?.hide();
        portalPromoCodeInput.value = "";
        portalPromoStatus.textContent = "";
        await ensureAccessToken(true);
        const userReady = await bootstrapUserProfile();
        if (userReady) {
          showPortal();
        }
      } catch (error) {
        const msg = error.message || "Promo code redemption failed.";
        setPortalPromoStatusText(msg);
        notify("danger", msg);
      } finally {
        applyPromoCodeBtn?.removeAttribute("disabled");
      }
    }

      function showPortal() {
        hidePortalPromoOfferPanel();
        portal.style.display = "flex";
        errorBox.textContent = "";
        if (!portalInitialized) {
          initializeDamageEntries();
          portalInitialized = true;
        } else {
          renumberDamageEntries();
        }
        fetchReports();
        loadSettings();
        applyTenantExperiencePreference();
        updatePowerBiSection();
      }

    async function fetchReports() {
      if (!ensurePortalAccess()) {
        return;
      }
      const filters = buildReportFilterParams();
        const queryString = buildReportQueryString(filters);
        reportsContainer.innerHTML = "<p class='text-muted'>Loading...</p>";
        toggleClearFiltersVisibility();
      try {
        const res = await apiFetch(`${apiBase}/report/pull${queryString}`);
        if (res.status === 403) {
          const data = await res.json().catch(() => null);
          const message =
            data?.error || "Your account lacks permission to view reports.";
          reportsContainer.innerHTML = `<div class="alert alert-warning">${escapeHtml(
            message
          )}</div>`;
          notify("warning", message);
          return;
        }
        if (!res.ok) {
          const errorPayload = await res.json().catch(() => null);
          const message =
            errorPayload?.error || `Server responded with ${res.status}`;
          throw new Error(message);
        }
        const data = await res.json();
        const reports = Array.isArray(data)
          ? data
          : Array.isArray(data?.reports)
          ? data.reports
          : [];
        latestReports = reports;
        updateAdminUserDropdown(reports);
        updateReportDateScopeControls(reports);
        } catch (err) {
          latestReports = [];
          updateAdminUserDropdown([]);
          reportsContainer.innerHTML = `<div class="alert alert-danger">Error loading reports: ${err.message}</div>`;
          notify("danger", `Unable to load reports. ${err.message || ""}`.trim());
        }
      }

      async function fetchDocuFitHealth() {
        if (!docufitHealthStatus) return;
        docufitHealthStatus.textContent = "Checking DocuFit health‚Ä¶";
        docufitHealthDetail.textContent = "";
        try {
          const res = await apiFetch(`${docuFitApiBase}/health`);
          const payload = await res.json().catch(() => null);
          if (!res.ok) {
            const err = payload?.error || payload?.message || `HTTP ${res.status}`;
            throw new Error(err);
          }
          const detail =
            payload?.status ||
            payload?.message ||
            "Operational";
          docufitHealthStatus.textContent = "DocuFit API is healthy";
          docufitHealthDetail.textContent = `${detail} ¬∑ ${new Date().toLocaleTimeString()}`;
        } catch (error) {
          const message =
            error?.message || "Unable to reach DocuFit health endpoint.";
          docufitHealthStatus.textContent = "DocuFit API unreachable";
          docufitHealthDetail.textContent = message;
          notify("warning", `DocuFit health check failed: ${message}`);
        }
      }

      function handleTenantExperienceSelection(event) {
        const nextValue = (event?.target?.value || "auto").toString();
        tenantExperiencePreference = nextValue;
        persistTenantExperiencePreference(nextValue);
        updateTenantExperienceBadge(nextValue);
        if (nextValue !== "auto") {
          applyTenantExperiencePreference(nextValue);
        }
      }

      function updateTenantExperienceBadge(value) {
        if (!tenantExperienceBadge) return;
        const normalized = (value || "auto").toString();
        const labels = {
          auto: "Auto-detect (Auth0 claims)",
          docudent: "DocuDent preferred",
          docufit: "DocuDent preferred",
        };
        const colors = {
          auto: "bg-secondary",
          docudent: "bg-primary",
          docufit: "bg-primary",
        };
        const label = labels[normalized] || labels.auto;
        const colorClass = colors[normalized] || colors.auto;
        tenantExperienceBadge.textContent = label;
        tenantExperienceBadge.className = `badge ${colorClass}`;
      }

      function persistTenantExperiencePreference(value) {
        try {
          localStorage?.setItem(TENANT_PREFERENCE_KEY, value);
        } catch (error) {
          console.warn("Unable to persist tenant preference", error);
        }
      }

      function loadTenantExperiencePreference() {
        try {
          const stored = localStorage?.getItem(TENANT_PREFERENCE_KEY);
          if (stored) {
            return stored;
          }
        } catch (error) {
          console.warn("Unable to read tenant preference", error);
        }
        return "auto";
      }

      function parseAppOriginMask(rawMask) {
        if (rawMask == null) {
          return 0;
        }
        if (typeof rawMask === "number" && Number.isFinite(rawMask)) {
          return rawMask;
        }
        const text = rawMask?.toString?.().trim();
        if (!text) {
          return 0;
        }
        const normalized = text.toLowerCase();
        const keywordMask =
          normalized
            .match(/[a-z]+/g)
            ?.reduce((mask, token) => mask | (APP_ORIGIN_ALIAS_MAP[token] || 0), 0) || 0;
        if (keywordMask) {
          return keywordMask;
        }
        const parsed = parseInt(normalized, 10);
        return Number.isNaN(parsed) ? 0 : parsed;
      }

      function hasAppOrigin(mask, bit) {
        return (mask & bit) === bit;
      }

      function hasCustomOrgAppAccess() {
        const normalizedPlan = (currentPlanTier || "").toString().trim().toLowerCase();
        if (!normalizedPlan) {
          return false;
        }
        return !RESTRICTED_APP_TIERS.has(normalizedPlan);
      }

      function getAppEntry(page) {
        return appNavEntries.find((entry) => entry.page === page) || null;
      }

      function getFirstAvailableApp() {
        return (
          appNavEntries.find((entry) => hasAppOrigin(currentAppOriginMask, entry.originBit)) ||
          null
        );
      }

      function updateAppNavigationVisibility(rawMask) {
        const mask =
          hasCustomOrgAppAccess() ?
            (APP_ORIGIN_DOCUDENT | APP_ORIGIN_DOCUFIT) :
            parseAppOriginMask(rawMask) || APP_ORIGIN_DOCUDENT;
        currentAppOriginMask = mask;
        appNavEntries.forEach((entry) => {
          const visible = hasAppOrigin(mask, entry.originBit);
          const navLink = entry.navLink;
          const section = entry.section;
          if (navLink) {
            navLink.classList.toggle("d-none", !visible);
            if (!visible) {
              navLink.classList.remove("active");
            }
          }
          if (section) {
            section.classList.toggle("d-none", !visible);
            if (!visible) {
              section.classList.remove("active");
            }
          }
        });
        const hasActiveApp = appNavEntries.some(
          (entry) => entry.navLink && entry.navLink.classList.contains("active"),
        );
        if (!hasActiveApp) {
          mainContent?.classList.remove("docu-fullscreen");
        }
      }

      function applyTenantExperiencePreference(value) {
        const preference = (value || tenantExperiencePreference || "auto").toString();
        if (!preference || preference === "auto") {
          return;
        }
        const targetPage = "docudent";
        const targetEntry = getAppEntry(targetPage);
        if (
          targetEntry &&
          targetEntry.navLink &&
          hasAppOrigin(currentAppOriginMask, targetEntry.originBit)
        ) {
          if (!targetEntry.navLink.classList.contains("active")) {
            targetEntry.navLink.click();
          }
          return;
        }
        const fallback = getFirstAvailableApp();
        if (fallback?.navLink && !fallback.navLink.classList.contains("active")) {
          fallback.navLink.click();
        }
      }

    function formatRelativeDate(value) {
      if (!value) return "No recent activity";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "No recent activity";
      const diffMs = Date.now() - date.getTime();
      const diffMinutes = Math.round(diffMs / 60000);
      if (diffMinutes < 1) return "Just now";
      if (diffMinutes < 60) {
        return `${diffMinutes} min${diffMinutes === 1 ? "" : "s"} ago`;
      }
      const diffHours = Math.round(diffMinutes / 60);
      if (diffHours < 24) {
        return `${diffHours} hr${diffHours === 1 ? "" : "s"} ago`;
      }
      const diffDays = Math.round(diffHours / 24);
      if (diffDays < 7) {
        return `${diffDays} day${diffDays === 1 ? "" : "s"} ago`;
      }
      return date.toLocaleDateString();
    }

    function normalizeMediaList(raw) {
      if (!raw) return [];
      if (Array.isArray(raw)) return raw.filter(Boolean);
      if (typeof raw === "string") {
        const trimmed = raw.trim();
        if (!trimmed.length) return [];
        try {
          const parsed = JSON.parse(trimmed);
          if (Array.isArray(parsed)) {
            return parsed.filter(Boolean);
          }
        } catch (_) {
          // Not JSON; treat as single URL string
        }
        return [trimmed];
      }
      return [];
    }

    function renderMediaGrid(
      urls,
      { imageClass = "", emptyMessage = "No media available." } = {}
    ) {
      if (!Array.isArray(urls) || urls.length === 0) {
        return `<p class="small text-muted mb-0">${escapeHtml(emptyMessage)}</p>`;
      }
      return `<div class="report-media-grid">${urls
        .map((url) => {
          const safeUrl = escapeHtml(url);
          const classes = ["report-media-img", imageClass].filter(Boolean).join(" ");
          return `<a href="${safeUrl}" target="_blank" rel="noopener"><img src="${safeUrl}" alt="Report media" class="${classes}" loading="lazy"></a>`;
        })
        .join("")}</div>`;
    }

    function resolveDamagePhotoUrl(photo) {
      if (!photo) return "";
      if (typeof photo === "string") {
        return photo.trim();
      }
      const candidates = [
        photo.signed_url,
        photo.signedUrl,
        photo.url,
        photo.file_path,
        photo.filePath,
      ];
      for (const candidate of candidates) {
        if (typeof candidate === "string" && candidate.trim().length) {
          return candidate.trim();
        }
      }
      return "";
    }

    function collectReportPhotoUrls(report) {
      if (!report) return [];
      const topLevel = normalizeMediaList(report.photo_urls);
      if (topLevel.length) {
        return topLevel;
      }
      const original = normalizeMediaList(report.photo_urls_original);
      if (original.length) {
        return original;
      }
      const aggregated = [];
      const entries = Array.isArray(report.damage_entries)
        ? report.damage_entries
        : [];
      entries.forEach((entry) => {
        const photos = Array.isArray(entry.photos) ? entry.photos : [];
        photos.forEach((photo) => {
          const url = resolveDamagePhotoUrl(photo);
          if (url) aggregated.push(url);
        });
      });
      return aggregated;
    }

    function renderDamageEntriesTable(report) {
      if (!report) {
        return `<p class="small text-muted mb-0">No damage entries were captured for this report.</p>`;
      }
      const formatCell = (value) => {
        if (value === null || value === undefined) return "‚Äî";
        if (typeof value === "string") {
          const trimmed = value.trim();
          return trimmed.length ? trimmed : "‚Äî";
        }
        if (typeof value === "number" || typeof value === "bigint") {
          return value.toString();
        }
        if (typeof value === "object") {
          if (typeof value.toString === "function") {
            const text = value.toString();
            if (text && text !== "[object Object]") {
              return text;
            }
          }
          try {
            const serialized = JSON.stringify(value);
            if (serialized && serialized !== "[]") {
              return serialized;
            }
          } catch (_) {
            /* ignore */
          }
          return "‚Äî";
        }
        return String(value);
      };

      const formatSeverity = (value) => {
        if (value === null || value === undefined || value === "") {
          return "‚Äî";
        }
        const numeric = Number(value);
        if (Number.isFinite(numeric) && SEVERITY_LABELS[numeric]) {
          return SEVERITY_LABELS[numeric];
        }
        const trimmed = String(value).trim();
        return trimmed.length ? trimmed : "‚Äî";
      };

      const rows = [];
      const addEntryRow = (zoneValue, typeValue, severityValue) => {
        if (!(zoneValue || typeValue || severityValue)) return;
        rows.push({
          zone: escapeHtml(formatCell(zoneValue)),
          type: escapeHtml(formatCell(typeValue)),
          severity: escapeHtml(formatSeverity(severityValue)),
        });
      };
      const normalizedEntries = Array.isArray(report.damage_entries)
        ? report.damage_entries
        : [];
      normalizedEntries.forEach((entry) => {
        if (!entry || typeof entry !== "object") return;
        addEntryRow(
          entry.damage_area ?? entry.damage_area_name ?? entry.area ?? "",
          entry.damage_type ?? entry.damage_type_name ?? entry.type ?? "",
          entry.severity ??
            entry.severity_level ??
            entry.severityLevel ??
            entry.severity_level_code ??
            ""
        );
      });
      if (!rows.length) {
        for (let index = 1; index <= 5; index += 1) {
          const zoneKey = `damage_area_${index}`;
          const typeKey = `damage_type_${index}`;
          const severityKey = `severity_${index}`;
          const zoneValue =
            report[zoneKey] ?? report[`damage_area${index}`] ?? "";
          const typeValue =
            report[typeKey] ?? report[`damage_type${index}`] ?? "";
          const severityValue =
            report[severityKey] ?? report[`severity${index}`] ?? "";
          if (!(zoneValue || typeValue || severityValue)) {
            continue;
          }
          rows.push({
            zone: escapeHtml(formatCell(zoneValue)),
            type: escapeHtml(formatCell(typeValue)),
            severity: escapeHtml(formatSeverity(severityValue)),
          });
        }
      }

      if (!rows.length) {
        return `<p class="small text-muted mb-0">No damage entries were captured for this report.</p>`;
      }

      const rowsHtml = rows
        .map(
          (row) => `
            <tr>
              <td>${row.zone}</td>
              <td>${row.type}</td>
              <td>${row.severity}</td>
            </tr>
          `,
        )
        .join("");

        return `
        <div class="damage-table-title text-center text-muted small fw-semibold mb-2">
          Damage Descriptors (AIAG)
        </div>
        <div class="damage-table-wrapper">
          <div class="table-responsive small">
            <table class="table table-sm table-borderless mb-0 damage-entry-table">
              <thead>
                <tr>
                  <th scope="col">Zone</th>
                  <th scope="col">Type</th>
                  <th scope="col">Severity</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderReportLocationInfo(report) {
      const normalizeText = (value) => {
        if (value === null || value === undefined) {
          return "";
        }
        return String(value).trim();
      };
      const bayLocation =
        normalizeText(
          report?.overview?.bay_location ?? report?.overview?.bayLocation
        ) || "";
      const navigationText =
        normalizeText(
          report?.overview?.navigation ??
            report?.overview?.navigation_text ??
            report?.overview?.navigationText ??
            report?.overview?.navigationInstructions
        ) || "";
      if (!bayLocation && !navigationText) {
        return "";
      }
      const lines = [];
      if (navigationText) {
        lines.push(
          `<div class="text-muted small mb-1"><strong>Location:</strong> ${escapeHtml(
            navigationText
          )}</div>`
        );
      }
      if (bayLocation) {
        lines.push(
          `<div class="text-muted small mb-1"><strong>Bay location:</strong> ${escapeHtml(
            bayLocation
          )}</div>`
        );
      }
      return `
        <div class="report-card-location-details mb-2 text-center">
          ${lines.join("")}
        </div>
      `;
    }

    function ensureSelectPicker(select) {
      const $select = $(select);
      if (typeof $select.selectpicker !== "function") return;
      if ($select.data("selectpicker")) {
        $select.selectpicker("refresh");
        return;
      }
      const parent = select.parentElement;
      if (parent && parent.classList && parent.classList.contains("bootstrap-select")) {
        if (parent.parentNode) {
          parent.parentNode.insertBefore(select, parent);
        }
        parent.remove();
      }
      $select.selectpicker();
    }

    function slugifyForLocationId(value) {
      if (!value) {
        return "";
      }
      const normalized = value
        .toString()
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
      return normalized || "";
    }

    function buildFacilityLocationId(name, label) {
      const labelSegment = slugifyForLocationId(label);
      const nameSegment = slugifyForLocationId(name);
      const fallbackSegment = "facility";
      const chosenSegment = labelSegment || nameSegment || fallbackSegment;
      const orgCandidate =
        currentOrganizationProfile?.organization_name ||
        currentOrganizationProfile?.organizationId ||
        currentOrganizationProfile?.organization_id ||
        organizationIdForBranding ||
        "";
      const orgSegment = slugifyForLocationId(orgCandidate) || "org";
      const base = `loc-${orgSegment}-${chosenSegment}`.replace(/-+/g, "-");
      return base.replace(/^-+|-+$/g, "");
    }

    function initializeDamageEntries(reset = false) {
      if (!damageEntriesContainer || !damageEntryTemplate) return;
      if (reset) {
        Array.from(damageEntriesContainer.children).forEach((entry) => {
          $(entry).find(".selectpicker").selectpicker("destroy");
          entry.remove();
        });
      }
      if (!damageEntriesContainer.querySelector(".damage-entry")) {
        addDamageEntry();
      } else {
        renumberDamageEntries();
      }
      updateSplatPreview();
    }

    function addDamageEntry() {
      if (!damageEntryTemplate || !damageEntriesContainer) return;
      if (damageEntriesContainer.children.length >= MAX_DAMAGE_ENTRIES) return;
      const clone = damageEntryTemplate.content.firstElementChild.cloneNode(true);
      damageEntriesContainer.appendChild(clone);
      attachDamageEntryHandlers(clone);
      renumberDamageEntries();
    }

    function attachDamageEntryHandlers(entry) {
      const removeBtn = entry.querySelector(".remove-damage-entry");
      if (removeBtn) {
        removeBtn.addEventListener("click", () => {
          $(entry).find(".selectpicker").selectpicker("destroy");
          entry.remove();
          renumberDamageEntries();
        });
      }
      const selects = entry.querySelectorAll("select");
      selects.forEach((select) => {
        select.addEventListener("change", () => {
          queueSplatPreviewUpdate();
        });
      });
      $(entry)
        .find(".selectpicker")
        .on("changed.bs.select", () => {
          queueSplatPreviewUpdate();
        });
    }

    function renumberDamageEntries() {
      if (!damageEntriesContainer) return;
      const entries = Array.from(damageEntriesContainer.querySelectorAll(".damage-entry"));
      entries.forEach((entry, idx) => {
        const index = idx + 1;
        entry.dataset.index = index;
        ["damage_area", "damage_type", "severity"].forEach((field) => {
          const select = entry.querySelector(`[data-field="${field}"]`);
          if (select) {
            select.name = `${field}_${index}`;
            ensureSelectPicker(select);
          }
        });
        const removeBtn = entry.querySelector(".remove-damage-entry");
        if (removeBtn) {
          removeBtn.classList.toggle("d-none", index === 1);
        }
      });
      if (addDamageEntryBtn) {
        addDamageEntryBtn.disabled = entries.length >= MAX_DAMAGE_ENTRIES;
      }
      queueSplatPreviewUpdate();
    }

    function collectDamageEntryModels() {
      if (!damageEntriesContainer) return [];
      return Array.from(damageEntriesContainer.querySelectorAll(".damage-entry"))
        .map((entry) => {
          const areaSelect = entry.querySelector('[data-field="damage_area"]');
          const typeSelect = entry.querySelector('[data-field="damage_type"]');
          const severitySelect = entry.querySelector('[data-field="severity"]');
          const areaCode = (areaSelect?.value || "").trim();
          if (!areaCode) return null;
          const areaLabel = areaSelect?.selectedOptions?.[0]?.textContent?.trim() || areaCode;
          const typeCode = (typeSelect?.value || "").trim();
          const typeLabel =
            typeSelect?.selectedOptions?.[0]?.textContent?.trim() || typeCode;
          const severityValue = parseInt((severitySelect?.value || "").trim(), 10);
          const severity = Number.isFinite(severityValue) ? severityValue : 1;
          const severityLabel =
            SEVERITY_LABELS[severity] || `Severity ${severity}`;
          return {
            entryId: entry.dataset.index || `entry-${areaCode}-${severity}`,
            areaCode,
            areaLabel,
            damageTypeCode: typeCode,
            damageTypeLabel: typeLabel,
            severityLevel: severity,
            severityLabel,
          };
        })
        .filter(Boolean);
    }

    function renderEmptySplat(message = "Add at least one damage entry to generate the splat chart preview.") {
      if (splatChartBox) {
        splatChartBox.innerHTML = `<div class="splat-preview-empty text-muted">${message}</div>`;
      }
      if (splatLegend) {
        splatLegend.innerHTML = "";
      }
      if (splatChartInput) splatChartInput.value = "";
      if (splatChartSvgInput) splatChartSvgInput.value = "";
      currentSplatPreview = null;
      splatPreviewPromise = Promise.resolve(null);
      lastSplatWarningKey = "";
    }

    function refreshSplatZoneSelect(entries) {
      if (!splatZoneSelect) return;
      const previous = splatZoneSelect.value;
      const options = Array.from(splatZoneSelect.options);
      options.slice(1).forEach((option) => option.remove());
      const uniqueCodes = new Map();
      entries.forEach((entry) => {
        if (!uniqueCodes.has(entry.areaCode)) {
          uniqueCodes.set(entry.areaCode, entry.areaLabel);
        }
      });
      uniqueCodes.forEach((label, code) => {
        const option = document.createElement("option");
        option.value = code;
        option.textContent = `${code} ‚Äì ${label.replace(/^\d+\s*-\s*/, "")}`;
        splatZoneSelect.appendChild(option);
      });
      if (previous && uniqueCodes.has(previous)) {
        splatZoneSelect.value = previous;
      } else {
        splatZoneSelect.value = "";
      }
    }

    function renderSplatLegend(entries) {
      if (!splatLegend) return;
      splatLegend.innerHTML = "";
      if (!entries.length) return;
      const severities = new Set(entries.map((entry) => entry.severityLevel));
      const sorted = Array.from(severities).sort((a, b) => a - b);
      sorted.forEach((severity) => {
        const bubble = document.createElement("span");
        const severityColor = SEVERITY_COLORS[severity] || "#0EA5E9";
        bubble.style.setProperty("--severity-chip-color", severityColor);
        bubble.style.color = "#0f172a";
        bubble.textContent =
          SEVERITY_LABELS[severity] || `Severity ${severity}`;
        splatLegend.appendChild(bubble);
      });
    }

    function renderSplatPreview(result, entries) {
      if (!result || !result.pngDataUrl) {
        renderEmptySplat("Unable to render splat chart preview.");
        return;
      }
      if (splatChartBox) {
        splatChartBox.innerHTML = `<img src="${result.pngDataUrl}" alt="Damage splat chart preview" />`;
      }
      if (splatChartInput) {
        if (result.pngDataUrl.startsWith("data:image/png")) {
          splatChartInput.value = result.pngDataUrl.replace(
            /^data:image\/png;base64,/,
            ""
          );
        } else {
          splatChartInput.value = "";
        }
      }
      if (splatChartSvgInput) {
        splatChartSvgInput.value = result.svg || "";
      }
      if (result.fallback === "svg") {
        notify("info", "Preview rendered as SVG; final report will include the vector chart.", { autoDismiss: true });
      }
      renderSplatLegend(entries);
      currentSplatPreview = result;
      const unmapped = Array.isArray(result.unmappedZones)
        ? result.unmappedZones.filter(Boolean)
        : [];
      if (unmapped.length) {
        const key = unmapped.slice().sort().join(",");
        if (key !== lastSplatWarningKey) {
          lastSplatWarningKey = key;
          notify(
            "warning",
            `Preview rendered without highlights for zone(s): ${unmapped.join(
              ", "
            )}`,
            { autoDismiss: false }
          );
        }
      } else if (lastSplatWarningKey) {
        lastSplatWarningKey = "";
      }
    }

    function queueSplatPreviewUpdate() {
      if (splatPreviewPending) return;
      updateSplatPreview();
    }

    function validateSplatRequest(entries) {
      if (!entries.length) {
        throw new Error("No damage entries provided.");
      }
      const invalid = entries.find(
        (entry) =>
          !entry.areaCode ||
          !entry.severityLevel ||
          Number.isNaN(entry.severityLevel)
      );
      if (invalid) {
        throw new Error(
          `Incomplete damage entry: zone ${invalid.areaCode || "unknown"}`
        );
      }
    }

    function validateSplatResponse(result) {
      if (!result) {
        throw new Error("Splat generator returned no result.");
      }
      if (typeof result.pngDataUrl !== "string" || !result.pngDataUrl.startsWith("data:image/png")) {
        throw new Error("Splat generator returned an invalid PNG payload.");
      }
      if (result.svg && typeof result.svg !== "string") {
        throw new Error("Splat generator returned an invalid SVG payload.");
      }
    }

    function logSplatFailure(error, context) {
      console.error("Failed to generate splat chart preview", error, context);
      notify(
        "danger",
        "Could not generate splat chart preview. Check console for details.",
        { autoDismiss: false }
      );
    }

    function clearSplatErrorState() {
      const dangerAlerts = [...alertContainer.querySelectorAll(".alert-danger")];
      dangerAlerts.forEach((alert) => {
        const text = alert.textContent || "";
        if (text.includes("splat chart")) {
          alert.remove();
        }
      });
    }

    function updateSplatPreview() {
      const entries = collectDamageEntryModels();
      refreshSplatZoneSelect(entries);
      if (!entries.length && (!splatZoneSelect || !splatZoneSelect.value)) {
        renderEmptySplat();
        return Promise.resolve(currentSplatPreview);
      }

      const payload = {
        damageEntries: entries.map((entry) => ({
          damageAreaCode: entry.areaCode,
          severityLevel: entry.severityLevel,
        })),
        selectedZone: splatZoneSelect?.value || "",
        showLabels: splatLabelsToggle?.checked ?? true,
      };

      try {
        validateSplatRequest(entries);
      } catch (validationError) {
        renderEmptySplat(validationError.message);
        logSplatFailure(validationError, { entries });
        return Promise.reject(validationError);
      }

      const task = (async () => {
        try {
          splatPreviewPending = true;
          if (splatChartBox) {
            splatChartBox.innerHTML = `<div class="splat-preview-empty text-muted">Generating splat chart‚Ä¶</div>`;
          }
          const result = await splatGenerator.generatePng(payload);
          validateSplatResponse(result);
          clearSplatErrorState();
          renderSplatPreview(result, entries);
          return currentSplatPreview;
        } catch (error) {
          renderEmptySplat("Failed to generate splat chart preview. Please try again.");
          logSplatFailure(error, { entries, payload });
          throw error;
        } finally {
          splatPreviewPending = false;
        }
      })();

      splatPreviewPromise = task.catch((err) => {
        currentSplatPreview = null;
        return Promise.reject(err);
      });
      return splatPreviewPromise;
    }

    async function ensureSplatPreviewReady() {
      try {
        await splatPreviewPromise;
      } catch (_) {
        // swallow to retry
      }
      if (!currentSplatPreview) {
        await updateSplatPreview();
        try {
          await splatPreviewPromise;
        } catch (_) {
          // ignore; caller will handle missing preview
        }
      }
      return currentSplatPreview;
    }

    function syncVisibleFromHidden() {
      if (vinVisible && vinField) vinVisible.value = vinField.value || "";
      if (makeVisible && makeField) makeVisible.value = makeField.value || "";
      if (modelVisible && modelField) modelVisible.value = modelField.value || "";
      if (yearVisible && yearField) yearVisible.value = yearField.value || "";
    }

    function syncHiddenFromVisible() {
      if (vinVisible && vinField) vinField.value = vinVisible.value.trim();
      if (makeVisible && makeField) makeField.value = makeVisible.value.trim();
      if (modelVisible && modelField) modelField.value = modelVisible.value.trim();
      if (yearVisible && yearField) yearField.value = yearVisible.value.trim();
    }

    function setManualOverride(enabled) {
      const fields = [vinVisible, makeVisible, modelVisible, yearVisible];
      fields.forEach((field) => {
        if (!field) return;
        field.disabled = !enabled;
        field.required = enabled;
        field.classList.toggle("manual-override-field", enabled);
      });
      if (manualOverrideHelp) {
        manualOverrideHelp.classList.toggle("text-warning", enabled);
        manualOverrideHelp.textContent = enabled
          ? "Manual override is on. Double-check these values before submitting."
          : "Turn this on to edit vehicle fields manually. Make sure the values match the inspection paperwork.";
      }
      if (enabled) {
        syncHiddenFromVisible();
      } else {
        syncVisibleFromHidden();
      }
    }

    setManualOverride(false);

    function escapeHtml(value) {
      return String(value ?? "").replace(/[&<>"']/g, (char) => {
        switch (char) {
          case "&":
            return "&amp;";
          case "<":
            return "&lt;";
          case ">":
            return "&gt;";
          case '"':
            return "&quot;";
          case "'":
            return "&#39;";
          default:
            return char;
        }
      });
    }

    function notify(variant, message, options = {}) {
      if (!alertContainer || !message) return;
      const { autoDismiss = true, dismissMs = 6000 } = options;
      const alertEl = document.createElement("div");
      alertEl.className = `alert alert-${variant} d-flex align-items-start justify-content-between portal-alert`;
      alertEl.setAttribute("role", "alert");
      const textWrap = document.createElement("div");
      textWrap.className = "me-3";
      textWrap.textContent = message;
      const closeBtn = document.createElement("button");
      closeBtn.type = "button";
      closeBtn.className = "btn-close";
      closeBtn.setAttribute("aria-label", "Dismiss notification");
      let timerId = null;
      closeBtn.addEventListener("click", () => {
        if (timerId) clearTimeout(timerId);
        alertEl.remove();
      });
      alertEl.appendChild(textWrap);
      alertEl.appendChild(closeBtn);
      alertContainer.appendChild(alertEl);
      while (alertContainer.children.length > 4) {
        alertContainer.firstElementChild?.remove();
      }
      if (autoDismiss) {
        timerId = setTimeout(() => {
          alertEl.remove();
        }, dismissMs);
      }
    }

    function loadSettings() {
      const theme = localStorage.getItem("theme") || "system";
      const font = localStorage.getItem("fontSize") || "default";
      const storedCb = localStorage.getItem("colorBlind") || "none";
      const cb =
        storedCb === "protanopia"
          ? "protan"
          : storedCb === "deuteranopia"
          ? "deutan"
          : storedCb === "tritanopia"
          ? "tritan"
          : storedCb;
      if (cb !== storedCb) localStorage.setItem("colorBlind", cb);
      const radio = document.getElementById(`theme-${theme}`);
      if (radio) radio.checked = true;
      if (fontSizeSelect) fontSizeSelect.value = font;
      if (colorBlindSelect) colorBlindSelect.value = cb;
      applySettings(theme, font, cb);
      try {
        const mql = window.matchMedia("(prefers-color-scheme: dark)");
        mql.addEventListener("change", () => {
          const saved = localStorage.getItem("theme") || "system";
          if (saved === "system") {
            applySettings(
              "system",
              fontSizeSelect?.value || "default",
              colorBlindSelect?.value || "none"
            );
          }
        });
      } catch (err) {
        console.warn("Could not attach system theme listener", err);
      }
    }

    function updatePortalLogos() {
      const useDark = document.body.classList.contains("dark");
      portalLogos?.forEach((img) => {
        if (!img) return;
        const light = img.dataset.lightSrc || img.dataset.src || img.src;
        const dark = img.dataset.darkSrc || light;
        const target = useDark ? dark : light;
        if (target && img.src !== target) {
          img.src = target;
        }
      });
    }

    function getPrimaryOrganizationName() {
      const candidate =
        currentOrganizationProfile?.organization_name ||
        currentOrganizationProfile?.name ||
        currentUserProfile?.organization?.name ||
        currentUserProfile?.organization_name ||
        "";
      return (candidate || "").toString().trim();
    }

    function getPrimaryOrganizationKey() {
      return (getPrimaryOrganizationName() || "").toLowerCase().trim();
    }
    function getPrimaryOrganizationId() {
      const candidate =
        currentOrganizationProfile?.organization_id ||
        currentOrganizationProfile?.organizationId ||
        currentUserProfile?.organization?.organization_id ||
        currentUserProfile?.organization?.organizationId ||
        currentUserProfile?.organization_id ||
        "";
      return (candidate || "").toString().trim().toLowerCase();
    }

    function isAwctOrganization() {
      const name = getPrimaryOrganizationName();
      return name.toLowerCase() === AWCT_ALLOWED_ORG;
    }
    function isInterRailOrganization() {
      return getPrimaryOrganizationKey() === INTER_RAIL_ALLOWED_ORG;
    }
    function isAcmeOrganization() {
      const orgKey = getPrimaryOrganizationKey();
      const orgId = getPrimaryOrganizationId();
      return (
        orgKey === ACME_ALLOWED_ORG || orgId === ACME_ALLOWED_ORG_ID
      );
    }

    function applyOrgLogoVariant() {
      const normalizedOrgKey = getPrimaryOrganizationKey();
      const customLogo = CUSTOM_ORG_LOGOS[normalizedOrgKey] || "";
      const isInterRail = normalizedOrgKey === INTER_RAIL_ALLOWED_ORG;
      portalLogos?.forEach((img) => {
        if (!img) return;
        if (customLogo) {
          img.dataset.lightSrc = customLogo;
          img.dataset.darkSrc = customLogo;
        } else {
          const defaults = portalLogoDefaults.get(img);
          if (defaults) {
            img.dataset.lightSrc = defaults.light;
            img.dataset.darkSrc = defaults.dark;
          }
        }
        if (isInterRail) {
          img.style.width = "140px";
        } else if (img.style.width) {
          img.style.width = "";
        }
      });
      if (sidebarHeader) {
        sidebarHeader.classList.toggle("logo-rect", Boolean(customLogo));
        sidebarHeader.classList.toggle("interrail", Boolean(customLogo) && isInterRail);
      }
      updatePortalLogos();
    }

    function updateDashboardVisibility() {
      const showDashboard = isAwctOrganization() || isInterRailOrganization();
      if (dashboardNavLink) {
        dashboardNavLink.classList.toggle("d-none", !showDashboard);
      }
      if (dashboardSection) {
        dashboardSection.classList.toggle("d-none", !showDashboard);
      }
      if (!showDashboard) {
        dashboardNavLink?.classList.remove("active");
        dashboardSection?.classList.remove("active");
        const reportsLink = document.querySelector('[data-page="reports"]');
        if (reportsLink && !reportsLink.classList.contains("active")) {
          reportsLink.click();
        }
      }
    }

    function applyOrganizationExperience() {
      applyOrgLogoVariant();
      updateDashboardVisibility();
      updateFormsVisibility();
    }
    function updateFormsVisibility() {
      const showForms = isAcmeOrganization();
      formsNavHeading?.classList.toggle("d-none", !showForms);
      formsNavLink?.classList.toggle("d-none", !showForms);
      if (formsSection) {
        formsSection.classList.toggle("d-none", !showForms);
      }
      if (!showForms) {
        const wasActive = formsSection?.classList.contains("active");
        formsSection?.classList.remove("active");
        formsNavLink?.classList.remove("active");
        if (wasActive) {
          const fallbackLink = document.querySelector('[data-page="dashboard"]');
          fallbackLink?.click();
        }
      }
    }
    function ensureAcmeFormsSectionRendered() {
      if (!isAcmeOrganization() || !acmeFormContainer) {
        return;
      }
      if (acmeFormEmbedRendered) {
        return;
      }
      if (!document.getElementById("formAnchor186144419")) {
        acmeFormContainer.innerHTML = "";
        const anchor = document.createElement("a");
        anchor.name = "form186144419";
        anchor.id = "formAnchor186144419";
        acmeFormContainer.appendChild(anchor);
      }
      if (!acmeFormScriptInjected) {
        acmeFormScriptInjected = true;
        const script = document.createElement("script");
        script.id = "acme-formsite-embed-script";
        script.src = ACME_FORM_EMBED_SCRIPT_URL;
        script.async = true;
        script.onload = renderAcmeFormsEmbed;
        document.body.appendChild(script);
      }
      renderAcmeFormsEmbed();
    }
    function renderAcmeFormsEmbed() {
      if (acmeFormEmbedRendered) {
        return;
      }
      if (!window.EmbedManager) {
        return;
      }
      EmbedManager.embed({
        key: ACME_FORM_EMBED_KEY,
        width: "100%",
      });
      acmeFormEmbedRendered = true;
    }

    function applySettings(theme, font, colorBlindMode) {
      document.body.classList.remove("dark", "font-small", "font-large");
      document.body.classList.remove(...COLOR_BLIND_CLASSES);
      if (
        theme === "dark" ||
        (theme === "system" && window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.body.classList.add("dark");
      }
      if (font === "small") {
        document.body.classList.add("font-small");
      } else if (font === "large") {
        document.body.classList.add("font-large");
      }
      if (colorBlindMode === "protan") {
        document.body.classList.add("cb-protan");
      } else if (colorBlindMode === "deutan") {
        document.body.classList.add("cb-deutan");
      } else if (colorBlindMode === "tritan") {
        document.body.classList.add("cb-tritan");
      }
      updatePortalLogos();
    }

    async function login(options = {}) {
      if (!auth0Client) return;
      await auth0Client.loginWithRedirect({
        authorizationParams: { audience, redirect_uri: redirectUri, ...options.authorizationParams },
      });
    }

    async function logout() {
      clearTokenTimer();
      accessToken = null;
      clearPortalAuthStorage();
      if (auth0Client) {
        showLoginScreen("Signing you out‚Ä¶");
        await auth0Client.logout({ logoutParams: { returnTo: redirectUri } });
      }
    }

    function registerEventHandlers() {
      loginButton?.addEventListener("click", async () => {
        try {
          loginButton.disabled = true;
          loginButton.classList.add("disabled");
          await login();
        } catch (err) {
          loginButton.disabled = false;
          loginButton.classList.remove("disabled");
          notify("danger", err.message || "Unable to start login. Try again.");
        }
      });
      openPromoModalBtn?.addEventListener("click", () => {
        setPortalPromoStatusText("");
        portalPromoCodeInput?.focus();
        portalPromoModalInstance?.show();
      });
      portalPromoForm?.addEventListener("submit", submitPortalPromoCode);
      addDamageEntryBtn?.addEventListener("click", () => addDamageEntry());
      refreshSplatBtn?.addEventListener("click", () => updateSplatPreview());
      splatZoneSelect?.addEventListener("change", () => updateSplatPreview());
      splatLabelsToggle?.addEventListener("change", () => updateSplatPreview());

      manualOverrideToggle?.addEventListener("change", (e) => {
        const enabled = e.target.checked;
        setManualOverride(enabled);
        if (enabled) {
          notify("info", "Manual override enabled. Ensure VIN details match paperwork.");
        } else {
          notify("info", "Manual override disabled. VIN decoder values restored.");
        }
      });

      [vinVisible, makeVisible, modelVisible, yearVisible].forEach((input) => {
        input?.addEventListener("input", () => {
          if (manualOverrideToggle?.checked) {
            syncHiddenFromVisible();
          }
        });
      });

      const docIframe = document.querySelector("#docudent iframe");

      document.querySelectorAll("#sidebar-content .nav-link").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const selectedPage = link.dataset.page;
          if (!selectedPage) return;
          const isAppPage = selectedPage === "docudent";
          if (isAppPage && !ensurePortalAccess()) {
            return;
          }
          document.querySelectorAll(".nav-link").forEach((l) => l.classList.remove("active"));
          document.querySelectorAll(".page-section").forEach((s) => {
            s.classList.remove("active");
            s.classList.add("d-none");
          });
          link.classList.add("active");
          const targetSection = document.getElementById(selectedPage);
          if (targetSection) {
            targetSection?.classList.remove("d-none");
            targetSection?.classList.add("active");
          }
          if (isAppPage) {
            mainContent?.classList.add("docu-fullscreen");
          } else {
            mainContent?.classList.remove("docu-fullscreen");
          }
          if (selectedPage === "reports") {
            fetchReports();
          }
          if (selectedPage === "settings") {
          }
          if (selectedPage === "branding") {
            loadBrandingPanel();
          }
          if (selectedPage === "docudent" && docIframe) {
            if (!docIframe.src || docIframe.src === "about:blank") {
              const dataSrc = docIframe.dataset.src;
              if (dataSrc) {
                docIframe.src = dataSrc;
              }
            }
          }
          if (selectedPage === "facilities") {
            loadFacilities();
          }
          if (selectedPage === "forms") {
            ensureAcmeFormsSectionRendered();
          }
        });
      });

      facilitiesList?.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const button =
          target.closest && target.closest(".edit-facility-btn");
        if (!button || !(button instanceof HTMLElement)) {
          return;
        }
        const locationId = button.dataset.locationId;
        if (!locationId) return;
        const facility = facilitiesCache.find(
          (entry) => entry.location_id === locationId,
        );
        if (facility) {
          prefillFacilityForm(facility);
        }
      });
      facilityForm?.addEventListener("submit", handleFacilityFormSubmit);
      facilityFormResetBtn?.addEventListener("click", () => resetFacilityForm());

      refreshDocuFitStatusBtn?.addEventListener("click", () => {
        fetchDocuFitHealth();
      });
      tenantExperienceSelect?.addEventListener("change", handleTenantExperienceSelection);
      if (tenantExperienceSelect) {
        tenantExperienceSelect.value = tenantExperiencePreference;
      }
      updateTenantExperienceBadge(tenantExperiencePreference);


      brandingColorInputs?.forEach((input) => {
        input.addEventListener("input", () => updateBrandingPreviewSwatch());
      });
      brandingPreviewSpacing?.addEventListener("input", (event) => {
        const value = Number(event.target?.value);
        setCustomThemeValues({
          previewPadding: Number.isNaN(value)
            ? DEFAULT_CUSTOM_THEME.previewPadding
            : value,
        });
      });
      brandingButtonRadius?.addEventListener("input", (event) => {
        const value = Number(event.target?.value);
        setCustomThemeValues({
          buttonRadius: Number.isNaN(value)
            ? DEFAULT_CUSTOM_THEME.buttonRadius
            : value,
        });
      });
      setCustomThemeValues();
      brandingLogoInput?.addEventListener("change", async (event) => {
        const file = event.target?.files?.[0];
        if (!file) return;
        if (brandingLogoStatus) {
          brandingLogoStatus.textContent = "Uploading logo‚Ä¶";
        }
        try {
          await uploadBrandingLogo(file);
        } catch (error) {
          notify("danger", error.message || "Logo upload failed.");
          if (brandingLogoStatus) {
            brandingLogoStatus.textContent = "Upload failed.";
          }
        }
      });
      brandingForm?.addEventListener("submit", handleBrandingFormSubmit);
      renderReportFilterOptions();

      refreshBtn?.addEventListener("click", () => {
        fetchReports();
      });
      reportFilterSelector?.addEventListener("change", (event) => {
        const selectedKey = event.target?.value;
        if (!selectedKey) return;
        if (selectedKey === TIMELINE_FILTER_KEY) {
          if (!reportDateTicks.length) {
            event.target.value = "";
            return;
          }
          setReportTimelineExpanded(!isReportTimelineExpanded);
          event.target.value = "";
          return;
        }
        const config = REPORT_FILTER_OPTIONS.find(
          (option) => option.key === selectedKey
        );
        if (!config) return;
        const entry = ensureReportFilterEntry(config);
        entry?.input?.focus();
        event.target.value = "";
      });
      clearReportFiltersBtn?.addEventListener("click", () => {
        clearReportFilters();
        fetchReports();
      });
      adminUserFilterSelect?.addEventListener("change", () => {
        const selectedValue = adminUserFilterSelect.value;
        if (!selectedValue) {
          removeReportFilter("user_uuid");
          scheduleReportRefresh(true);
          return;
        }
        const entry = ensureReportFilterEntry({
          key: "user_uuid",
          label: "User",
          placeholder: "Select a user",
          readOnly: true,
        });
        if (!entry) return;
        const selectedOption =
          adminUserFilterSelect.selectedOptions?.[0] ?? null;
        const label = selectedOption?.textContent || "User";
        entry.input.value = label;
        entry.input.dataset.filterValue = selectedValue;
        toggleClearFiltersVisibility();
        scheduleReportRefresh(true);
      });
      logoutBtn?.addEventListener("click", async (e) => {
        e.preventDefault();
        await logout();
      });
      decodeBtn?.addEventListener("click", async () => {
        const vin = vinInput.value.trim().toUpperCase();
        if (!vin) {
          vinStatus.textContent = "Please enter a VIN.";
          return;
        }
        if (vinInput.value !== vin) {
          vinInput.value = vin;
        }
        if (vin.length !== 17) {
          notify(
            "warning",
            "VINs should be 17 characters; decoder results may be incomplete."
          );
        }
        vinStatus.innerHTML = `<span class="text-muted"><span class="spinner-border spinner-border-sm me-1"></span>Decoding VIN‚Ä¶</span>`;
        carInfoBox.style.display = "none";
        decodeLabel?.classList.add("d-none");
        decodeSpin?.classList.remove("d-none");
        try {
          const res = await fetch(
            `https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvaluesextended/${encodeURIComponent(vin)}?format=json`
          );
          if (!res.ok) {
            throw new Error(`Decoder returned ${res.status}`);
          }
          const data = await res.json();
          const r = (data && Array.isArray(data.Results) && data.Results[0]) || {};
          const make = (r.Make || "").trim();
          const model = (r.Model || "").trim();
          const year = (r.ModelYear || "").trim();
          const trim = (r.Trim || "").trim();
          const engine = (r.EngineModel || r.EngineConfiguration || "").trim();
          vinField.value = vin;
          makeField.value = make;
          modelField.value = model;
          yearField.value = year;
          syncVisibleFromHidden();
          carMake.textContent = make || "‚Äî";
          carModel.textContent = model || "‚Äî";
          carYear.textContent = year || "‚Äî";
          carTrimEngine.textContent =
            [trim, engine].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî";
          const errorCodeRaw = (r.ErrorCode || "").toString().trim();
          const condensedErrorCode = errorCodeRaw.replace(/[,\s]/g, "");
          const hasDecodeError =
            condensedErrorCode.length > 0 && !/^0+$/.test(condensedErrorCode);
          const errorDetail = (r.ErrorText || r.AdditionalErrorText || "").trim();
          carInfoBox.style.display =
            make || model || year || trim || engine ? "block" : "none";
          if (hasDecodeError) {
            const warningMessage = errorDetail
              ? `${errorDetail} Enable manual override to verify.`
              : "VIN decoder could not confirm this VIN. Enable manual override to verify.";
            vinStatus.innerHTML = `<span class="text-warning">${escapeHtml(
              errorDetail ||
                "VIN decoder could not confirm this VIN. Use manual override below to review the details."
            )}</span>`;
            notify("warning", warningMessage);
            if (manualOverrideToggle && !manualOverrideToggle.checked) {
              manualOverrideToggle.checked = true;
            }
            setManualOverride(true);
          } else {
            vinStatus.innerHTML = `<span class="text-success">VIN decoded. Review vehicle details below.</span>`;
            if (manualOverrideToggle) {
              manualOverrideToggle.checked = false;
            }
            setManualOverride(false);
          }
        } catch (err) {
          const offline =
            err.name === "TypeError" || (err.message && /Network|fetch/i.test(err.message));
          const message = offline
            ? "VIN decoder is unreachable. Check your connection or enable manual override."
            : "VIN decoder could not process this value. Double-check the VIN or enable manual override.";
          vinStatus.innerHTML = `<span class="text-danger">${escapeHtml(message)}</span>`;
          notify("danger", message);
          if (manualOverrideToggle && !manualOverrideToggle.checked) {
            manualOverrideToggle.checked = true;
          }
          setManualOverride(true);
        } finally {
          decodeLabel?.classList.remove("d-none");
          decodeSpin?.classList.add("d-none");
        }
      });

      photosInput?.addEventListener("change", (e) => {
        photoPreview.innerHTML = "";
        const files = Array.from(e.target.files || []);
        files.forEach((file) => {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          photoPreview.appendChild(img);
        });
        uploadNote.textContent = files.length ? `${files.length} file(s) selected.` : "";
      });

      damageForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const photoFiles = photosInput.files;
        if (!photoFiles.length) {
          damageResult.innerHTML = `<div class="alert alert-warning mb-0">Please attach at least one photo.</div>`;
          return;
        }
        if (!vinField.value || !makeField.value || !modelField.value || !yearField.value) {
          damageResult.innerHTML = `<div class="alert alert-warning mb-0">Please decode VIN and confirm vehicle info before submitting.</div>`;
          return;
        }
        if (!damageForm.reportValidity()) return;
        damageResult.innerHTML = "";
        uploadProgressWrap.classList.remove("d-none");
        uploadProgress.style.width = "0%";
        uploadProgress.textContent = "0%";
        uploadNote.textContent = "Uploading photos‚Ä¶";
        const damageSummary = collectDamageEntryModels();
        let splatResult = null;
        try {
          splatResult = await ensureSplatPreviewReady();
        } catch (previewError) {
          notify(
            "warning",
            "Submitting without splat preview due to preview error.",
            { autoDismiss: false }
          );
        }

        const submitBtn = document.getElementById("submitReportBtn");
        const submitLabel = submitBtn.querySelector(".submit-label");
        const submitSpin = submitBtn.querySelector(".submit-spinner");
        submitLabel.classList.add("d-none");
        submitSpin.classList.remove("d-none");
        submitBtn.disabled = true;
        try {
          const uploads = [];
          const total = photoFiles.length;
          for (let i = 0; i < total; i++) {
            const file = photoFiles[i];
            const upData = new FormData();
            upData.append("photo", file);
            const uploadRes = await apiFetch(`${apiBase}/photos/upload`, {
              method: "POST",
              body: upData,
            });
            const uploadText = await uploadRes.text();
            let uploadData = null;
            try {
              uploadData = uploadText ? JSON.parse(uploadText) : null;
            } catch (parseErr) {
              console.error("Upload response parse failed", parseErr, uploadText);
              throw new Error("Upload failed: invalid response from server.");
            }
            if (!uploadRes.ok) {
              throw new Error(uploadData?.error || "Upload failed");
            }
            const uploadedUrl =
              uploadData?.url ||
              (Array.isArray(uploadData?.urls) ? uploadData.urls[0] : null);
            if (!uploadedUrl) throw new Error("Upload response missing URL.");
            uploads.push(uploadedUrl);
            const pct = Math.round(((i + 1) / total) * 100);
            uploadProgress.style.width = pct + "%";
            uploadProgress.textContent = pct + "%";
            uploadNote.textContent = `Uploading photos‚Ä¶ (${i + 1}/${total})`;
          }
          const formEntries = Object.fromEntries(new FormData(damageForm).entries());
          formEntries.vin = vinField.value;
          formEntries.make = makeField.value;
          formEntries.model = modelField.value;
          formEntries.year = yearField.value;
          const damageEntriesPayload = damageSummary.map((entry) => ({
            entryId: entry.entryId,
            damageAreaCode: entry.areaCode,
            damageAreaName: entry.areaLabel,
            damageTypeCode: entry.damageTypeCode,
            damageTypeName: entry.damageTypeLabel,
            severityLevel: entry.severityLevel,
            severityLabel: entry.severityLabel,
            createdAt: new Date().toISOString(),
          }));
          formEntries.damage_summary = damageEntriesPayload;
          formEntries.damage_entries = damageEntriesPayload;
          const areaCodes = damageEntriesPayload.map((entry) => entry.damageAreaCode || null);
          const typeCodes = damageEntriesPayload.map((entry) => entry.damageTypeCode || null);
          const severityLevels = damageEntriesPayload.map((entry) => entry.severityLevel ?? null);
          ["damage_area_1", "damage_area_2", "damage_area_3", "damage_area_4", "damage_area_5"].forEach(
            (field, index) => {
              formEntries[field] = areaCodes[index] ?? null;
            }
          );
          ["damage_type_1", "damage_type_2", "damage_type_3", "damage_type_4", "damage_type_5"].forEach(
            (field, index) => {
              formEntries[field] = typeCodes[index] ?? null;
            }
          );
          ["severity_1", "severity_2", "severity_3", "severity_4", "severity_5"].forEach(
            (field, index) => {
              formEntries[field] = severityLevels[index] ?? null;
            }
          );
          if (splatChartInput && splatChartInput.value) {
            formEntries.splat_chart_png = splatChartInput.value;
          }
          if (splatChartSvgInput && splatChartSvgInput.value) {
            formEntries.splat_chart_svg = splatChartSvgInput.value;
          }
          if (splatResult?.highlightedZones) {
            formEntries.highlighted_zones = splatResult.highlightedZones;
          }
          if (!formEntries.status) formEntries.status = "verified";
          formEntries.photo_urls = uploads;
          delete formEntries.photos;
          uploadNote.textContent = "Submitting report‚Ä¶";
          const res = await apiFetch(`${apiBase}/reports`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formEntries),
          });
          const textPayload = await res.text();
          let data = null;
          try {
            data = textPayload ? JSON.parse(textPayload) : null;
          } catch (parseErr) {
            console.error("Report submission parse failed", parseErr, textPayload);
            throw new Error("Submission failed: invalid server response.");
          }
          if (!res.ok) throw new Error(data?.error || "Submission failed");
          damageResult.innerHTML = `<div class="alert alert-success mb-0">Report submitted successfully. <strong>ID:</strong> ${data?.report_id || "N/A"}</div>`;
          const recipients = [];
          if (currentUserProfile?.email) recipients.push(currentUserProfile.email);
          if (formEntries.inspector_email) recipients.push(formEntries.inspector_email);
          if (!recipients.length && data?.recipient_email) {
            recipients.push(data.recipient_email);
          }
          if (recipients.length) {
            try {
              await sendMailgunEmail({
                recipients,
                subject: `Damage Report ${formEntries.vin}`.trim(),
                report: {
                  id: data?.report_id,
                  vin: formEntries.vin,
                  make: formEntries.make,
                  model: formEntries.model,
                  year: formEntries.year,
                  status: formEntries.status,
                  comments: formEntries.comments || "",
                  submittedAt: new Date().toISOString(),
                },
                damageEntries: damageEntriesPayload,
                damageSummary: damageEntriesPayload.map((entry) => ({
                  areaCode: entry.damageAreaCode,
                  areaLabel: entry.damageAreaName,
                  damageTypeCode: entry.damageTypeCode,
                  damageTypeLabel: entry.damageTypeName,
                  severityLevel: entry.severityLevel,
                  severityLabel: entry.severityLabel,
                })),
                photoUrls: uploads,
                splatChartPng: splatChartInput?.value || null,
                splatChartSvg: splatChartSvgInput?.value || null,
              });
            } catch (mailErr) {
              console.error("Mailgun notification failed", mailErr);
              notify(
                "warning",
                mailErr.message ||
                  "Report saved, but email notification failed. Please contact support.",
                { autoDismiss: false }
              );
            }
          }
          damageForm.reset();
          initializeDamageEntries(true);
          $(".selectpicker").selectpicker("refresh");
          photoPreview.innerHTML = "";
          uploadNote.textContent = "";
          uploadProgress.style.width = "0%";
          uploadProgress.textContent = "0%";
          fetchReports();
          if (manualOverrideToggle) {
            manualOverrideToggle.checked = false;
          }
          setManualOverride(false);
          carInfoBox.style.display = "none";
          vinStatus.textContent = "";
          renderEmptySplat();
        } catch (err) {
          damageResult.innerHTML = `<div class="alert alert-danger mb-0">Error: ${err.message}</div>`;
          notify("danger", err.message || "Report submission failed.", {
            autoDismiss: false,
          });
        } finally {
          submitLabel.classList.remove("d-none");
          submitSpin.classList.add("d-none");
          submitBtn.disabled = false;
          uploadProgressWrap.classList.add("d-none");
        }
      });

      document.addEventListener("change", (e) => {
        if (e.target && e.target.name === "themeMode") {
          const val = e.target.value;
          localStorage.setItem("theme", val);
          applySettings(
            val,
            fontSizeSelect?.value || "default",
            colorBlindSelect?.value || "none"
          );
        }
      });
      fontSizeSelect?.addEventListener("change", (e) => {
        localStorage.setItem("fontSize", e.target.value);
        const themeValue =
          (document.querySelector('input[name="themeMode"]:checked') || {}).value ||
          "system";
        applySettings(themeValue, e.target.value, colorBlindSelect?.value || "none");
      });
      colorBlindSelect?.addEventListener("change", (e) => {
        const themeValue =
          (document.querySelector('input[name="themeMode"]:checked') || {}).value ||
          "system";
        localStorage.setItem("colorBlind", e.target.value);
        applySettings(themeValue, fontSizeSelect?.value || "default", e.target.value);
      });
      deleteBtn?.addEventListener("click", async () => {
        if (
          !confirm(
            "Are you sure you want to permanently delete your account? This cannot be undone."
          )
        )
          return;
        try {
          const res = await apiFetch(`${apiBase}/users/me`, { method: "DELETE" });
          if (!res.ok) throw new Error("Deletion failed");
          notify("success", "Account deleted. Signing out‚Ä¶");
          await logout();
        } catch (err) {
          notify("danger", err.message || "Account deletion failed.");
        }
      });
      tosLink?.addEventListener("click", (e) => {
        e.preventDefault();
        window.open(
          "https://nulanesystems.com/terms",
          "tosWindow",
          "width=900,height=680,resizable,scrollbars"
        );
      });
    }

    restoreSidebarCollapsedState();
    registerEventHandlers();

    (async function initAuth() {
      try {
        auth0Client = await auth0.createAuth0Client({
          domain,
          clientId,
          authorizationParams: { audience, redirect_uri: redirectUri },
          cacheLocation: "localstorage",
          useRefreshTokens: true,
        });
        const search = window.location.search;
        if (search.includes("code=") && search.includes("state=")) {
          try {
            await auth0Client.handleRedirectCallback();
          } catch (err) {
            console.warn("Auth0 redirect callback failed", err);
            notify(
              "warning",
              "Login redirect did not complete cleanly. Please try signing in again.",
              { autoDismiss: true },
            );
          } finally {
            window.history.replaceState({}, document.title, redirectUri);
          }
        }
        const storedPortalToken = window.localStorage.getItem("portal_token");
        const isAuthenticated = await auth0Client.isAuthenticated();
        if (!isAuthenticated && (!storedPortalToken || storedPortalToken === "")) {
          notify("info", "Redirecting to Auth0 so you can sign in and access the portal.");
          await login();
          return;
        }
        try {
          await ensureAccessToken();
        } catch (error) {
          console.warn("Token acquisition skipped", error);
        }
        await bootstrapUserProfile();
        showPortal();
      } catch (error) {
        console.error("Initialization error:", error);
        clearPortalAuthStorage();
        showLoginScreen("Unable to initialize portal. Please try again.");
        errorBox.textContent = "Unable to initialize portal. Please try again.";
        notify("danger", "Unable to initialize portal. Please try again.", {
          autoDismiss: false,
        });
      }
    })();
</script>
<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//stats.nulanesystems.com/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->
</body>
</html>
